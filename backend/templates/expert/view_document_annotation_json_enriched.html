{# template/expert/view_document_json_enriched.html #}
{% extends "base.html" %}
{% load static %}
{% load expert_extras %}
{% block title %}JSON S√©mantique Expert - {{ document.title }} ‚Äì RegExpert{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'rawdocs/css/rlhf_styles.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/loader.min.js"></script>

{# --- JSON DATA SAFE PASSING --- #}
{{ global_annotations_json|json_script:"basic-json-data" }}
{{ enriched_annotations_json|default:"{}"|json_script:"enriched-json-data" }}
{{ display_json|default:"{}"|json_script:"display-json-data" }}

<style>
:root{
  --pharma-primary:#3b82f6;--pharma-accent:#10b981;--pharma-info:#06b6d4;
  --pharma-success:#059669;--pharma-warning:#f59e0b;
  --pharma-bg-card:#fff;--pharma-bg:#f8fafc;--pharma-text:#1e293b;--pharma-text-soft:#64748b;
  --pharma-border:#e2e8f0;--pharma-radius:12px;--pharma-radius-sm:8px;--pharma-shadow:0 4px 16px rgba(15,23,42,.08);
  --pharma-transition:.3s cubic-bezier(.4,0,.2,1);
  --ai-color:#3b82f6;--expert-color:#10b981;--diff-bg:#f8fafc;--improvement-bg:#ecfdf5;--correction-bg:#fef2f2;
}
body{background:var(--pharma-bg);color:var(--pharma-text);font-family:Inter,-apple-system,BlinkMacSystemFont,sans-serif}

/* Tabs */
.mode-tabs{display:flex;background:linear-gradient(135deg,#f9fafb,#f3f4f6);border-radius:var(--pharma-radius);padding:.75rem;margin-bottom:2rem;box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border)}
.mode-tab{flex:1;padding:1rem 1.5rem;text-align:center;border-radius:var(--pharma-radius-sm);background:transparent;border:1px solid transparent;color:var(--pharma-text-soft);cursor:pointer;transition:var(--pharma-transition);font-weight:600;display:flex;align-items:center;justify-content:center;gap:.5rem}
.mode-tab:hover{background:rgba(59,130,246,.1);color:var(--pharma-primary)}
.mode-tab.active{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;border-color:var(--pharma-primary);box-shadow:0 4px 12px rgba(59,130,246,.3)}

/* Cards */
.semantic-card{background:var(--pharma-bg-card);border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border);margin-bottom:1.5rem;overflow:hidden;transition:var(--pharma-transition)}
.semantic-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(15,23,42,.12)}
.semantic-card-header{background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(16,185,129,.1));padding:1.5rem;border-bottom:1px solid var(--pharma-border)}
.semantic-card-header h3{font-size:1.25rem;font-weight:600;color:var(--pharma-text);margin:0;display:flex;align-items:center;gap:.75rem}
.semantic-card-body{padding:1.5rem}

/* Relations list */
.relations-container{display:flex;flex-direction:column;gap:1rem}
.relation-item{background:linear-gradient(135deg,rgba(59,130,246,.05),rgba(16,185,129,.05));border:1px solid rgba(59,130,246,.2);border-radius:var(--pharma-radius-sm);padding:1rem;display:flex;align-items:center;gap:1rem;transition:var(--pharma-transition);flex-wrap:wrap}
.relation-item:hover{background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(16,185,129,.1));border-color:var(--pharma-primary)}
.entity-node{background:var(--pharma-primary);color:#fff;padding:.5rem 1rem;border-radius:20px;font-size:.9rem;font-weight:500;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;position:relative}
.entity-node:hover{max-width:none;white-space:normal;word-break:break-word;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,.15)}
.relation-arrow{color:var(--pharma-accent);font-size:1.2rem;font-weight:bold}
.relation-type{background:var(--pharma-accent);color:#fff;padding:.3rem .8rem;border-radius:15px;font-size:.8rem;font-weight:500;white-space:nowrap}

/* Q&A */
.qa-container{display:flex;flex-direction:column;gap:1rem}
.qa-item{background:linear-gradient(135deg,rgba(6,182,212,.05),rgba(139,92,246,.05));border:1px solid rgba(6,182,212,.2);border-radius:var(--pharma-radius-sm);padding:1.5rem}
.qa-question{font-weight:600;color:var(--pharma-text);margin-bottom:.75rem;display:flex;gap:.5rem}
.qa-question::before{content:"Q:";color:var(--pharma-info);font-weight:700}
.qa-answer{color:var(--pharma-text-soft);line-height:1.6;margin-left:1.75rem;display:flex;gap:.5rem}
.qa-answer::before{content:"R:";color:var(--pharma-accent);font-weight:700}

/* QA test */
.qa-test-interface{background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(251,191,36,.1));border:1px solid rgba(245,158,11,.3);border-radius:var(--pharma-radius);padding:1.5rem;margin-bottom:2rem}
.qa-input-group{display:flex;gap:1rem;align-items:flex-end;margin-bottom:1rem}
.qa-input{flex:1;padding:.75rem 1rem;border:2px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);font-size:1rem}
.qa-input:focus{outline:none;border-color:var(--pharma-warning);box-shadow:0 0 0 3px rgba(245,158,11,.1)}
.qa-test-btn{padding:.75rem 1.5rem;background:var(--pharma-warning);color:#fff;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.5rem}
.qa-test-btn:hover{background:#d97706;transform:translateY(-1px)}
.qa-result{background:#fff;border-radius:8px;padding:1rem;border-left:4px solid var(--pharma-success);margin-top:1rem;display:none}

/* JSON panels */
.json-comparison{display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-bottom:2rem}
.json-panel{background:#fff;border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border);padding:1.5rem}
.json-panel h4{font-size:1.1rem;font-weight:600;margin-bottom:1rem;color:var(--pharma-text);display:flex;align-items:center;gap:.5rem}

/* Learning Section */
.learning-section{background:linear-gradient(135deg,rgba(16,185,129,.05),rgba(59,130,246,.05));border:2px solid var(--pharma-accent);border-radius:var(--pharma-radius);padding:1.5rem;margin-bottom:2rem}
.learning-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
.learning-header h4{color:var(--pharma-text);margin:0;display:flex;align-items:center;gap:.5rem}
.learning-actions{display:flex;gap:.75rem;flex-wrap:wrap}
.learning-btn{padding:.5rem 1rem;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.4rem;align-items:center;transition:var(--pharma-transition)}
.learning-btn.primary{background:linear-gradient(135deg,var(--expert-color),#059669);color:#fff}
.learning-btn.secondary{background:var(--pharma-text-soft);color:#fff}
.learning-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}

/* Comparison cards */
.comparison-card{border-radius:12px;box-shadow:0 4px 16px rgba(15,23,42,.08);margin-bottom:1rem;overflow:hidden;background:white;position:relative}
.delta-header{background:linear-gradient(135deg,var(--diff-bg),#e2e8f0);padding:1rem 1.5rem;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
.delta-type-badge{padding:.4rem 1rem;border-radius:20px;font-size:.85rem;font-weight:600}
.delta-type-relation_added{background:var(--improvement-bg);color:var(--expert-color)}
.delta-type-relation_modified{background:#fef3c7;color:#d97706}
.delta-type-qa_added{background:var(--improvement-bg);color:var(--expert-color)}
.delta-type-qa_corrected{background:#fef3c7;color:#d97706}
.version-comparison{display:grid;grid-template-columns:1fr 1fr;gap:1rem;padding:1rem}
.ai-version,.expert-version{padding:1rem;border-radius:8px;border:2px solid}
.ai-version{border-color:var(--ai-color);background:rgba(59,130,246,.05)}
.expert-version{border-color:var(--expert-color);background:rgba(16,185,129,.05)}
.version-header{display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem;font-weight:600}
.ai-version .version-header{color:var(--ai-color)}
.expert-version .version-header{color:var(--expert-color)}
.relation-display{background:#f8fafc;padding:.75rem;border-radius:6px;font-family:'Courier New',monospace;margin-bottom:.5rem}
.description-text{font-style:italic;color:#64748b;margin-top:.5rem}
.improvement-indicator{position:absolute;top:-5px;right:-5px;background:var(--expert-color);color:white;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px}
.learning-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1rem}
.learning-stat{background:white;padding:1rem;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.learning-stat-value{font-size:1.5rem;font-weight:800;color:var(--expert-color);margin-bottom:.25rem}
.learning-stat-label{font-size:.8rem;color:var(--pharma-text-soft)}

/* Actions */
.enrichment-actions{display:flex;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}
.enrichment-btn{padding:.75rem 1.5rem;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.5rem;transition:var(--pharma-transition)}
.enrichment-btn.primary{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff}
.enrichment-btn.secondary{background:var(--pharma-text-soft);color:#fff}
.enrichment-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.15)}

/* ===== Modales (plein √©cran & corps fluide) ===== */
.semantic-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:9999;display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
.semantic-modal.show{display:flex;animation:fadeInModal .4s ease-out}
.modal-content-semantic{background:#fff;border-radius:var(--pharma-radius);box-shadow:0 25px 80px rgba(0,0,0,.4);width:98vw;max-width:98vw;height:92vh;max-height:92vh;overflow:hidden}
.modal-content-semantic.fullscreen{width:100vw;max-width:100vw;height:100vh;max-height:100vh;border-radius:0}
.modal-header-semantic{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;padding:1.25rem 1.75rem;display:flex;justify-content:space-between;align-items:center}
.modal-body-semantic{padding:0;height:calc(92vh - 64px);overflow:hidden}
.modal-content-semantic.fullscreen .modal-body-semantic{height:calc(100vh - 64px)}

/* ===== VRB en grille pleine hauteur AVEC SIDE-BY-SIDE ===== */
.visual-relation-builder{
  position:relative;background:linear-gradient(135deg,#f8fafc,#ffffff);
  border:2px solid var(--pharma-border);border-radius:var(--pharma-radius);
  height:100%;min-height:620px;overflow:hidden;
  display:grid;grid-template-columns:30% 70%;grid-template-rows:1fr;
  gap:0;
}

/* Layout Side-by-Side */
.vrb-left-panel{
  grid-column:1;grid-row:1;
  border-right:2px solid var(--pharma-border);
  display:flex;flex-direction:column;
  background:#f8fafc;
  height:100%;
  overflow:hidden;
}

.vrb-right-panel{
  grid-column:2;grid-row:1;
  display:grid;grid-template-rows:auto 1fr auto;
  position:relative;
  padding-right:420px; /* r√©serve palette - √âLARGI */
  height:100%;
  overflow:hidden;
}

/* PDF Viewer */
.pdf-viewer-container{
  display:flex;flex-direction:column;height:100%;min-height:500px;
}

.pdf-toolbar{
  background:linear-gradient(135deg,rgba(59,130,246,.08),rgba(16,185,129,.08));
  padding:0.5rem 0.75rem;
  border-bottom:1px solid var(--pharma-border);
  display:flex;justify-content:space-between;align-items:center;
  flex-wrap:wrap;gap:0.4rem;
}

.pdf-controls{
  display:flex;gap:0.5rem;align-items:center;
}

.pdf-page-info{
  font-size:0.9rem;
  color:var(--pharma-text);
  font-weight:500;
}

.pdf-nav-btn{
  padding:0.3rem 0.6rem;
  border:1px solid var(--pharma-border);
  background:#fff;
  border-radius:6px;
  cursor:pointer;
  transition:var(--pharma-transition);
  font-size:0.75rem;
}

.pdf-nav-btn:hover:not(:disabled){
  background:var(--pharma-primary);
  color:#fff;
  border-color:var(--pharma-primary);
}

.pdf-nav-btn:disabled{
  opacity:0.5;
  cursor:not-allowed;
}

.pdf-viewer-frame{
  flex:1;
  width:100%;
  height:100%;
  min-height:400px;
  border:none;
  background:#525659;
}

.pdf-selection-mode{
  display:flex;gap:0.5rem;align-items:center;
  padding:0.5rem;
  background:rgba(16,185,129,.1);
  border-radius:6px;
}

.pdf-selection-mode label{
  display:flex;align-items:center;gap:0.3rem;
  font-size:0.85rem;
  cursor:pointer;
}

/* Highlight dans PDF */
.pdf-highlight{
  background:rgba(59,130,246,.3);
  cursor:pointer;
  transition:var(--pharma-transition);
}

.pdf-highlight:hover{
  background:rgba(59,130,246,.5);
}

/* Barre d‚Äôoutils */
.builder-toolbar{background:linear-gradient(135deg,rgba(59,130,246,.05),rgba(16,185,129,.05));padding:0.6rem 0.8rem;border-bottom:1px solid var(--pharma-border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.6rem}
.builder-modes{display:flex;gap:.3rem}
.mode-switch{padding:.3rem .6rem;border:1px solid var(--pharma-border);background:#fff;border-radius:16px;cursor:pointer;transition:var(--pharma-transition);font-size:.75rem;display:flex;align-items:center;gap:.3rem}
.mode-switch.active{background:var(--pharma-primary);color:#fff;border-color:var(--pharma-primary)}
.mode-switch:hover:not(.active){background:rgba(59,130,246,.1)}
.builder-actions{display:flex;gap:.4rem;align-items:center}
.builder-btn{padding:.3rem .6rem;border:1px solid var(--pharma-border);background:#fff;border-radius:var(--pharma-radius-sm);cursor:pointer;transition:var(--pharma-transition);font-size:.75rem;display:flex;align-items:center;gap:.3rem}
.builder-btn.primary{background:var(--pharma-primary);color:#fff;border-color:var(--pharma-primary)}
.builder-btn:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.1)}

/* Canvas */
.visual-canvas{position:relative;min-height:420px;height:100%;overflow:hidden}
.connection-svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5}

/* Entit√©s */
.canvas-entity{position:absolute;background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;padding:0.5rem 0.8rem;border-radius:18px;cursor:move;transition:var(--pharma-transition);box-shadow:0 3px 12px rgba(59,130,246,.3);z-index:10;min-width:90px;text-align:center;font-weight:600;font-size:0.8rem;user-select:none;word-break:break-word;max-width:180px}
.canvas-entity:hover{transform:scale(1.03);box-shadow:0 6px 20px rgba(59,130,246,.4)}
.canvas-entity.dragging{z-index:20;transform:scale(1.05);box-shadow:0 8px 24px rgba(59,130,246,.5)}
.canvas-entity.source{background:linear-gradient(135deg,#3b82f6,#6366f1)}
.canvas-entity.target{background:linear-gradient(135deg,#10b981,#059669)}
.canvas-entity.connecting{animation:pulse 1.5s infinite}

/* Points de connexion */
.connection-point{position:absolute;width:12px;height:12px;background:var(--pharma-accent);border:2px solid #fff;border-radius:50%;cursor:crosshair;transform:translate(-50%,-50%);transition:var(--pharma-transition);box-shadow:0 1px 4px rgba(16,185,129,.4)}
.connection-point:hover{transform:translate(-50%,-50%) scale(1.2);background:var(--pharma-warning)}
.connection-point.right{right:-6px;top:50%}
.connection-point.left{left:-6px;top:50%}

/* Palette */
.entity-palette{position:absolute;right:0;top:0;width:420px;height:100%;background:linear-gradient(180deg,#ffffff,#f8fafc);border-left:1px solid var(--pharma-border);padding:0.75rem;overflow-y:auto;z-index:15}
.entity-palette h4{font-size:0.9rem;font-weight:600;color:var(--pharma-text);margin-bottom:0.75rem;display:flex;align-items:center;gap:.4rem}
.entity-search{width:100%;padding:.75rem;border:2px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);margin-bottom:1rem;font-size:.9rem}
.entity-search:focus{outline:none;border-color:var(--pharma-primary);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
.entity-list{display:flex;flex-direction:column;gap:.5rem}
.entity-item{background:#fff;border:1px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);padding:.75rem;cursor:grab;transition:var(--pharma-transition);display:flex;justify-content:space-between;align-items:center}
.entity-item:hover{border-color:var(--pharma-primary);transform:translateX(-2px);box-shadow:0 4px 12px rgba(59,130,246,.15)}
.entity-item:active{cursor:grabbing}
.entity-type-label{background:var(--pharma-primary);color:#fff;padding:.2rem .5rem;border-radius:12px;font-size:.7rem;font-weight:600}

/* Form cr√©ation entit√© */
.create-entity-form{background:rgba(16,185,129,.05);border:1px dashed var(--pharma-accent);border-radius:var(--pharma-radius-sm);padding:1rem;margin-bottom:1rem}
.create-entity-input{width:100%;padding:.5rem;border:1px solid var(--pharma-border);border-radius:6px;margin-bottom:.5rem;font-size:.85rem}
.create-entity-btn{width:100%;padding:.5rem;background:var(--pharma-accent);color:#fff;border:none;border-radius:6px;font-size:.85rem;font-weight:600;cursor:pointer}

/* Onglets de la palette */
.palette-tabs{display:flex;border-bottom:2px solid var(--pharma-border);margin:-0.75rem -0.75rem 0.75rem -0.75rem;padding:0 0.75rem;background:#fff}
.palette-tab{flex:1;padding:0.5rem 0.3rem;text-align:center;cursor:pointer;border-bottom:3px solid transparent;transition:var(--pharma-transition);font-size:0.75rem;font-weight:500;color:var(--pharma-text-soft)}
.palette-tab:hover{background:rgba(59,130,246,.05);color:var(--pharma-primary)}
.palette-tab.active{color:var(--pharma-primary);border-bottom-color:var(--pharma-primary);font-weight:600}
.palette-tab i{margin-right:.2rem;font-size:.8rem}
.palette-content{max-height:calc(100vh - 160px);overflow-y:auto}

/* Annotation Selector */
.annotation-selector-container{margin-bottom:1rem}
.annotation-search{width:100%;padding:.75rem;border:2px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);margin-bottom:.75rem;font-size:.85rem}
.annotation-search:focus{outline:none;border-color:var(--pharma-accent);box-shadow:0 0 0 3px rgba(16,185,129,.1)}
.annotation-select{width:100%;border:1px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);padding:.5rem;font-size:.85rem;margin-bottom:.75rem;background:#fff;cursor:pointer}
.annotation-select option{padding:.5rem;margin:.2rem 0}
.annotation-select option:hover{background:rgba(59,130,246,.1)}
.annotation-actions{display:flex;gap:.5rem;margin-bottom:.75rem}
.annotation-action-btn{flex:1;padding:.6rem;border:1px solid var(--pharma-border);background:#fff;border-radius:var(--pharma-radius-sm);cursor:pointer;transition:var(--pharma-transition);font-size:.8rem;display:flex;align-items:center;justify-content:center;gap:.3rem}
.annotation-action-btn:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.1)}
.annotation-action-btn.primary{background:var(--pharma-accent);color:#fff;border-color:var(--pharma-accent)}
.annotation-action-btn.primary:hover{background:#059669}
.annotation-preview{background:rgba(59,130,246,.05);border:1px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);padding:.75rem;margin-top:.75rem}
.annotation-preview-header{font-weight:600;margin-bottom:.5rem;font-size:.85rem;color:var(--pharma-primary)}
.annotation-preview-content{font-size:.8rem;line-height:1.5;color:var(--pharma-text);max-height:150px;overflow-y:auto;background:#fff;padding:.5rem;border-radius:4px}
.annotation-stats{display:flex;gap:1rem;padding:.75rem;background:rgba(16,185,129,.08);border-radius:var(--pharma-radius-sm);margin-top:.75rem}
.stat-item{flex:1;text-align:center;font-size:.8rem}
.stat-label{display:block;color:var(--pharma-text-soft);margin-bottom:.25rem;font-size:.75rem}
.stat-item span:last-child{display:block;font-size:1.2rem;font-weight:700;color:var(--pharma-accent)}

/* JSON Viewer */
.json-viewer-controls{display:flex;gap:.4rem;margin-bottom:.75rem;flex-wrap:wrap}
.json-control-btn{flex:1;min-width:80px;padding:.5rem;background:#fff;border:1px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);cursor:pointer;transition:var(--pharma-transition);font-size:.75rem;display:flex;align-items:center;justify-content:center;gap:.3rem}
.json-control-btn:hover{background:var(--pharma-primary);color:#fff;border-color:var(--pharma-primary)}
.json-control-btn.primary{background:var(--pharma-primary);color:#fff}
.json-viewer{background:#ffffff;border:2px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);padding:0;max-height:600px;overflow:hidden}
#json-monaco-editor{width:100%;height:600px;border-radius:var(--pharma-radius-sm)}

/* Panel types de relation ‚Äì visible et centr√© (grand √©cran) */
.relation-types-panel{
  position:absolute;bottom:calc(12px + 60px);
  left:50%;transform:translateX(-50%);
  background:#fff;border:1px solid var(--pharma-border);border-radius:var(--pharma-radius);
  box-shadow:0 8px 24px rgba(0,0,0,.15);padding:0.75rem;display:none;z-index:1000;
  max-width:min(600px, calc(100% - 440px)); /* ne pas passer sous la palette */
}
.relation-types-panel.show{display:block;animation:slideUp .25s ease-out}
.relation-type-option{padding:.3rem .5rem;border:1px solid var(--pharma-border);background:#fff;border-radius:16px;cursor:pointer;margin:.15rem;display:inline-block;font-size:.75rem;transition:var(--pharma-transition)}
.relation-type-option:hover{background:var(--pharma-primary);color:#fff;transform:translateY(-1px)}
.relation-type-option.custom{border-style:dashed;color:var(--pharma-warning)}

/* R√©sum√© */
.relations-summary{grid-row:3;position:relative;background:linear-gradient(135deg,rgba(255,255,255,.95),rgba(248,250,252,.95));border-top:1px solid var(--pharma-border);padding:0.6rem;backdrop-filter:blur(10px)}
.summary-title{font-weight:600;color:var(--pharma-text);margin-bottom:.3rem;display:flex;align-items:center;gap:.3rem;font-size:0.85rem}
.relations-count{background:var(--pharma-accent);color:#fff;padding:.15rem .4rem;border-radius:10px;font-size:.7rem;font-weight:600}
.relation-preview-item{background:rgba(59,130,246,.05);border:1px solid rgba(59,130,246,.2);border-radius:16px;padding:.25rem .5rem;margin:.15rem;display:inline-flex;align-items:center;gap:.3rem;font-size:.7rem}
.relation-preview-item .edit{cursor:pointer}

/* Dialog de description */
.relation-desc-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.25);display:none;z-index:900}
.relation-desc-backdrop.show{display:block}
.relation-desc-dialog{
  position:absolute;left:50%;top:35%;transform:translate(-50%,-35%);
  background:#fff;border:1px solid var(--pharma-border);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.2);
  width:min(720px, calc(100% - 360px)); max-width:720px;padding:1rem;display:none;z-index:1100
}
.relation-desc-dialog.show{display:block}
.relation-desc-dialog h5{margin:0 0 .5rem 0}
.relation-desc-dialog textarea{width:100%;min-height:90px;border:2px solid var(--pharma-border);border-radius:8px;padding:.75rem}
.relation-desc-actions{display:flex;justify-content:flex-end;gap:.5rem;margin-top:.75rem}

/* Responsive Side-by-Side */
@media (max-width:1600px){
  .visual-relation-builder{grid-template-columns:25% 75%}
  .vrb-right-panel{padding-right:380px}
  .entity-palette{width:380px}
}
@media (max-width:1400px){
  .visual-relation-builder{grid-template-columns:25% 75%}
  .vrb-right-panel{padding-right:340px}
  .entity-palette{width:340px}
}
@media (max-width:1200px){
  .visual-relation-builder{grid-template-columns:1fr;grid-template-rows:280px 1fr}
  .vrb-left-panel{grid-column:1;grid-row:1;border-right:none;border-bottom:2px solid var(--pharma-border);height:280px}
  .vrb-right-panel{grid-column:1;grid-row:2;padding-right:300px}
  .entity-palette{width:300px}
}
@media (max-width:1024px){
  .vrb-right-panel{display:block;padding-right:0}
  .entity-palette{position:relative;width:100%;height:auto;border-left:none;border-top:1px solid var(--pharma-border)}
  .relations-summary{position:relative}
  .visual-canvas{min-height:360px}
  .relation-types-panel{max-width:100%;left:50%;transform:translateX(-50%)}
  .relation-desc-dialog{width:96%;max-width:96%}
  .pdf-toolbar{flex-direction:column;align-items:stretch}
  .pdf-controls{justify-content:center}
}
@media (max-width:768px){
  .json-comparison{grid-template-columns:1fr}
  .enrichment-actions{flex-direction:column}
  .mode-tabs{flex-direction:column}
  .qa-input-group{flex-direction:column}
  .version-comparison{grid-template-columns:1fr}
  .modal-content-semantic{width:98vw;height:92vh}
  .builder-toolbar{flex-direction:column;align-items:stretch}
}

/* Stats (Overview) */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem;margin-bottom:1rem}
.stat-card{display:flex;align-items:center;gap:12px;background:var(--pharma-bg-card);border:1px solid var(--pharma-border);border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);padding:1rem 1.25rem}
.stat-icon{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,rgba(59,130,246,.12),rgba(16,185,129,.12));color:var(--pharma-primary);flex:0 0 44px}
.stat-content{display:flex;flex-direction:column;line-height:1.1}
.stat-value{font-size:1.6rem;font-weight:800;color:var(--pharma-primary)}
.stat-label{font-size:.95rem;color:var(--pharma-text-soft);margin-top:2px}

/* Animations */
@keyframes fadeInModal{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
@keyframes slideUp{from{transform:translateX(-50%) translateY(20px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(59,130,246,.7)}50%{box-shadow:0 0 0 10px rgba(59,130,246,0)}}


/* Ajouter dans le style CSS */
.canvas-entity.has-existing-relations {
  border: 2px solid var(--expert-color);
  box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
}

.canvas-entity.has-existing-relations::after {
  content: '‚óè';
  position: absolute;
  top: -5px;
  right: -5px;
  background: var(--expert-color);
  color: white;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
}


/* Ajouter dans le style CSS */
.found-relation-item {
  background: rgba(59,130,246,.05);
  border: 1px solid rgba(59,130,246,.2);
  border-radius: 8px;
  padding: 1rem;
  margin: 0.5rem 0;
  display: flex;
  align-items: center;
  gap: 1rem;
  transition: var(--pharma-transition);
}

.found-relation-item:hover {
  background: rgba(59,130,246,.1);
  border-color: var(--pharma-primary);
}

.found-relation-content {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.found-entity-node {
  background: var(--pharma-primary);
  color: #fff;
  padding: 0.3rem 0.8rem;
  border-radius: 15px;
  font-size: 0.8rem;
  font-weight: 500;
}

.found-relation-type {
  background: var(--pharma-accent);
  color: #fff;
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 500;
}

.found-relation-description {
  font-style: italic;
  color: var(--pharma-text-soft);
  font-size: 0.85rem;
  margin-top: 0.5rem;
}

.found-relation-actions {
  display: flex;
  gap: 0.5rem;
}

.found-relation-btn {
  padding: 0.3rem 0.6rem;
  border: 1px solid var(--pharma-border);
  background: #fff;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.75rem;
  transition: var(--pharma-transition);
}

.found-relation-btn:hover {
  background: var(--pharma-primary);
  color: #fff;
  border-color: var(--pharma-primary);
}

.found-relation-btn.delete {
  color: #dc2626;
  border-color: #dc2626;
}

.found-relation-btn.delete:hover {
  background: #dc2626;
  color: #fff;
}
</style>

<section class="semantic-card">
  <div class="semantic-card-header">
    <h2><i class="fas fa-brain"></i> JSON S√©mantique Expert - {{ document.title|truncatechars:50 }}</h2>
  </div>
  <div class="semantic-card-body">
    <div class="mode-tabs">
      <div class="mode-tab active" data-mode="overview"><i class="fas fa-chart-pie"></i>Vue d'ensemble</div>
      <div class="mode-tab" data-mode="relations"><i class="fas fa-project-diagram"></i>Relations ({{ enriched_stats.relations_count|default:0 }})</div>
      <div class="mode-tab" data-mode="qa"><i class="fas fa-question-circle"></i>Q&A ({{ enriched_stats.qa_pairs_count|default:0 }})</div>
      <div class="mode-tab" data-mode="json"><i class="fas fa-graduation-cap"></i>JSON & Apprentissage</div>
    </div>

    <div class="enrichment-actions">
      {% if not has_enriched %}
        <button class="enrichment-btn primary" onclick="enrichDocumentJSON()"><i class="fas fa-magic"></i>Enrichir Automatiquement</button>
      {% else %}
        <button class="enrichment-btn secondary" onclick="regenerateEnrichment()"><i class="fas fa-sync-alt"></i>R√©g√©n√©rer</button>
      {% endif %}
      <button class="enrichment-btn primary" onclick="showVisualRelationBuilder()"><i class="fas fa-project-diagram"></i>Cr√©ateur Visuel de Relations</button>
      <button class="enrichment-btn primary" onclick="showAddQAModal()"><i class="fas fa-question"></i>Ajouter Q&A</button>
      <button class="enrichment-btn primary" onclick="showAddTextModal()"><i class="fas fa-paragraph"></i>Analyser un Paragraphe</button>
      <button class="enrichment-btn primary" onclick="showDocumentPageAnalysis()"><i class="fas fa-file-medical-alt"></i> Analyser Documents Valid√©s</button>
      <a href="{% url 'expert:annotation_dashboard' %}" class="enrichment-btn secondary"><i class="fas fa-arrow-left"></i>Retour Dashboard</a>
    </div>
  </div>
</section>

{# --- OVERVIEW --- #}
<div id="overview-tab" class="tab-content">
  {% if has_enriched %}
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-project-diagram"></i></div>
      <div class="stat-content">
        <div class="stat-value">{{ enriched_stats.relations_count|default:0 }}</div>
        <div class="stat-label">Relations identifi√©es</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-question-circle"></i></div>
      <div class="stat-content">
        <div class="stat-value">{{ enriched_stats.qa_pairs_count|default:0 }}</div>
        <div class="stat-label">Questions-R√©ponses</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-layer-group"></i></div>
      <div class="stat-content">
        <div class="stat-value">{{ enriched_stats.contexts_count|default:0 }}</div>
        <div class="stat-label">Contextes s√©mantiques</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-list-check"></i></div>
      <div class="stat-content">
        <div class="stat-value">{{ total_annotations|default:0 }}</div>
        <div class="stat-label">Annotations totales</div>
      </div>
    </div>
  </div>

  {% if enriched_annotations_json.semantic_summary %}
  <div class="semantic-card">
    <div class="semantic-card-header"><h3><i class="fas fa-lightbulb"></i> R√©sum√© S√©mantique Intelligent</h3></div>
    <div class="semantic-card-body"><p style="font-size:1.1rem;line-height:1.8">{{ enriched_annotations_json.semantic_summary }}</p></div>
  </div>
  {% endif %}

  <div class="qa-test-interface">
    <h4><i class="fas fa-vial"></i> Tester le Syst√®me de Questions-R√©ponses</h4>
    <div style="display:flex;gap:1rem;align-items:center;margin:.25rem 0 1rem">
      <label style="display:flex;gap:.4rem;align-items:center"><input type="radio" name="qa-source" value="basic"> JSON basique</label>
      <label style="display:flex;gap:.4rem;align-items:center"><input type="radio" name="qa-source" value="enriched" checked> JSON enrichi</label>
    </div>
    <div class="qa-input-group">
      <input type="text" id="test-question" class="qa-input" placeholder="ex: Quel est le dosage du produit ?">
      <button class="qa-test-btn" onclick="testQASystem()"><i class="fas fa-search"></i>Tester</button>
    </div>
    <div id="qa-test-result" class="qa-result"></div>
    <div id="qa-correction" class="qa-result" style="display:none;border-left-color:#f59e0b">
      <div style="font-weight:600;margin-bottom:.5rem;color:#1e293b"><i class="fas fa-edit"></i> Corriger la r√©ponse</div>
      <textarea id="qa-corrected" class="form-control" rows="4" placeholder="Proposez la meilleure r√©ponse..."></textarea>
      <div style="text-align:right;margin-top:.5rem">
        <button class="enrichment-btn secondary" onclick="sendQACorrection()"><i class="fas fa-save"></i>Enregistrer la correction</button>
      </div>
    </div>
  </div>
  {% else %}
  <div class="semantic-card">
    <div class="semantic-card-body" style="text-align:center;padding:3rem">
      <i class="fas fa-brain" style="font-size:4rem;color:var(--pharma-text-soft);margin-bottom:1rem"></i>
      <h3>JSON Non Enrichi</h3>
      <p>Ce document poss√®de un JSON basique mais pas encore d'enrichissement s√©mantique.</p>
      <button class="enrichment-btn primary" onclick="enrichDocumentJSON()"><i class="fas fa-magic"></i>Enrichir Automatiquement</button>
    </div>
  </div>
  {% endif %}
</div>

{# --- RELATIONS --- #}
<div id="relations-tab" class="tab-content" style="display:none">
  <div class="semantic-card">
    <div class="semantic-card-header"><h3><i class="fas fa-project-diagram"></i> Relations Entre Entit√©s</h3></div>
    <div class="semantic-card-body">
      <div id="relations-container" class="relations-container">
        {% if enriched_annotations_json.relations %}
          {% for relation in enriched_annotations_json.relations %}
          <div class="relation-item">
            <div class="entity-node">{{ relation.source.value }}</div>
            <div class="relation-type">{{ relation.type|default:"relation" }}</div>
            <div class="relation-arrow">‚Üí</div>
            <div class="entity-node">{{ relation.target.value }}</div>
            {% if relation.description %}<small style="color:var(--pharma-text-soft);margin-left:auto">{{ relation.description }}</small>{% endif %}
          </div>
          {% endfor %}
        {% else %}
          <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft)">
            <i class="fas fa-project-diagram" style="font-size:3rem;margin-bottom:1rem"></i>
            <p>Aucune relation identifi√©e. Utilisez le cr√©ateur visuel de relations.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# --- Q&A --- #}
<div id="qa-tab" class="tab-content" style="display:none">
  <div class="semantic-card">
    <div class="semantic-card-header"><h3><i class="fas fa-question-circle"></i> Questions-R√©ponses Automatiques</h3></div>
    <div class="semantic-card-body">
      <div id="qa-container" class="qa-container">
        {% if enriched_annotations_json.questions_answers %}
          {% for qa in enriched_annotations_json.questions_answers %}
          <div class="qa-item">
            <div class="qa-question">{{ qa.question }}</div>
            <div class="qa-answer">{{ qa.answer }}</div>
            {% if qa.created_by == "expert" %}
              <div style="margin-top:.5rem">
                <span style="background:var(--pharma-success);color:#fff;padding:.2rem .5rem;border-radius:10px;font-size:.7rem"><i class="fas fa-user-check"></i> Expert</span>
              </div>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
          <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft)">
            <i class="fas fa-question-circle" style="font-size:3rem;margin-bottom:1rem"></i>
            <p>Aucune Q&A g√©n√©r√©e. Utilisez "Ajouter Q&A".</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# --- JSON & APPRENTISSAGE --- #}
<div id="json-tab" class="tab-content" style="display:none">
  <div class="learning-section">
    <div class="learning-header">
      <h4><i class="fas fa-graduation-cap"></i> Apprentissage Expert IA</h4>
      <div class="learning-actions">
        <button class="learning-btn primary" onclick="compareWithFreshAI()">
          <i class="fas fa-balance-scale"></i>Comparer avec IA
        </button>
        <button class="learning-btn primary" onclick="regenerateWithLearning()">
          <i class="fas fa-magic"></i>R√©g√©n√©rer +Apprentissage
        </button>
        <button class="learning-btn secondary" onclick="viewDetailedHistory()">
          <i class="fas fa-history"></i>Historique d√©taill√©
        </button>
      </div>
    </div>
    <div class="learning-stats" id="learning-stats">
      <div class="learning-stat"><div class="learning-stat-value" id="corrections-count">-</div><div class="learning-stat-label">Corrections totales</div></div>
      <div class="learning-stat"><div class="learning-stat-value" id="relations-improved">-</div><div class="learning-stat-label">Relations am√©lior√©es</div></div>
      <div class="learning-stat"><div class="learning-stat-value" id="qa-improved">-</div><div class="learning-stat-label">Q&A am√©lior√©es</div></div>
      <div class="learning-stat"><div class="learning-stat-value" id="patterns-reused">-</div><div class="learning-stat-label">Patterns r√©utilis√©s</div></div>
    </div>
    <div id="comparison-results" style="display:none">
      <h5><i class="fas fa-microscope"></i> Derni√®re comparaison IA vs Expert</h5>
      <div id="comparison-cards-container"></div>
    </div>
  </div>

  <div class="json-comparison">
    <div class="json-panel">
      <h4><i class="fas fa-file-code"></i> JSON Basique</h4>
      <div id="basic-json-editor" style="height:500px;border:1px solid var(--pharma-border);border-radius:8px"></div>
    </div>
    {% if has_enriched %}
    <div class="json-panel">
      <h4><i class="fas fa-brain"></i> JSON Enrichi</h4>
      <div id="enriched-json-editor" style="height:500px;border:1px solid var(--pharma-border);border-radius:8px"></div>
    </div>
    {% else %}
    <div class="json-panel" style="display:flex;align-items:center;justify-content:center;background:var(--pharma-bg)">
      <div style="text-align:center;color:var(--pharma-text-soft)">
        <i class="fas fa-brain" style="font-size:3rem;margin-bottom:1rem"></i>
        <p>JSON enrichi disponible apr√®s enrichissement</p>
      </div>
    </div>
    {% endif %}
  </div>

  <div style="text-align:center;margin-top:1rem">
    <button class="enrichment-btn primary" onclick="saveJSONChanges()"><i class="fas fa-save"></i>Sauvegarder les Modifications</button>
  </div>
</div>

{# --- MODAL CR√âATEUR VISUEL DE RELATIONS --- #}
<div id="visual-relation-modal" class="semantic-modal">
  <div class="modal-content-semantic">
    <div class="modal-header-semantic">
      <h3><i class="fas fa-project-diagram"></i> Cr√©ateur Visuel de Relations</h3>
      <div>
        <button id="vrb-fullscreen-btn" class="builder-btn" onclick="toggleVRBFullscreen()"><i class="fas fa-expand"></i> Plein √©cran</button>
        <button style="background:none;border:none;color:#fff;font-size:1.5rem;margin-left:.5rem" onclick="hideModal('visual-relation-modal')">√ó</button>
      </div>
    </div>
    <div class="modal-body-semantic">
      <div class="visual-relation-builder">

        <!-- PANNEAU GAUCHE: PDF Viewer -->
        <div class="vrb-left-panel">
          <div class="pdf-viewer-container">
            <div class="pdf-toolbar">
              <div class="pdf-controls">
                <button class="pdf-nav-btn" id="pdf-prev-page" onclick="navigatePDFPage(-1)">
                  <i class="fas fa-chevron-left"></i> Pr√©c√©dent
                </button>
                <span class="pdf-page-info" id="pdf-page-info">Page <span id="current-pdf-page">1</span> / <span id="total-pdf-pages">{{ document.total_pages }}</span></span>
                <button class="pdf-nav-btn" id="pdf-next-page" onclick="navigatePDFPage(1)">
                  Suivant <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              <div class="pdf-selection-mode">
                <label>
                  <input type="checkbox" id="pdf-selection-enabled" onchange="togglePDFSelection(this.checked)">
                  <i class="fas fa-hand-pointer"></i> Mode s√©lection de texte
                </label>
              </div>
            </div>
            {% if document.file %}
            <iframe
              id="pdf-viewer-frame"
              class="pdf-viewer-frame"
              src="{% url 'expert:proxy_pdf' document.id %}#page=1&view=FitH"
              data-fallback-url="{{ document.file.url }}#page=1&view=FitH"
              title="Visualiseur PDF"
              onload="console.log('PDF charg√© via proxy:', '{% url 'expert:proxy_pdf' document.id %}');"
              onerror="handlePDFLoadError(this);">
            </iframe>
            {% else %}
            <div style="display:flex;align-items:center;justify-content:center;height:100%;background:#f8fafc;color:var(--pharma-text-soft);flex-direction:column;gap:1rem;">
              <i class="fas fa-file-pdf" style="font-size:4rem;"></i>
              <p>Aucun fichier PDF disponible pour ce document</p>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- PANNEAU DROIT: Canvas de Relations -->
        <div class="vrb-right-panel">
          <!-- Barre d'outils -->
          <div class="builder-toolbar">
            <div class="builder-modes">
              <div class="mode-switch active" data-mode="connect"><i class="fas fa-link"></i> Mode Connexion</div>
              <div class="mode-switch" data-mode="move"><i class="fas fa-arrows-alt"></i> Mode D√©placement</div>
            </div>
            <div class="builder-actions">
              <button class="builder-btn" onclick="clearCanvas()"><i class="fas fa-trash"></i> Effacer</button>
              <button class="builder-btn" onclick="autoArrange()"><i class="fas fa-magic"></i> Auto-organiser</button>
              <button class="builder-btn primary" onclick="saveAllRelations()"><i class="fas fa-save"></i> Sauvegarder tout</button>
            </div>
          </div>

          <!-- Canvas -->
          <div class="visual-canvas" id="visual-canvas">
            <svg class="connection-svg" id="connection-svg" preserveAspectRatio="none">
              <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="var(--pharma-accent)" />
                </marker>
              </defs>
            </svg>
          </div>

          <!-- Palette -->
          <div class="entity-palette">
            <!-- Onglets de la palette -->
            <div class="palette-tabs">
              <div class="palette-tab active" data-tab="entities" onclick="switchPaletteTab('entities')">
                <i class="fas fa-cubes"></i> Entit√©s
              </div>
              <div class="palette-tab" data-tab="annotations" onclick="switchPaletteTab('annotations')">
                <i class="fas fa-tags"></i> Annotations
              </div>
              <div class="palette-tab" data-tab="json" onclick="switchPaletteTab('json')">
                <i class="fas fa-code"></i> JSON
              </div>
            </div>

            <!-- Contenu: Entit√©s -->
            <div class="palette-content" id="palette-entities-content">
              <h4><i class="fas fa-cubes"></i> Entit√©s disponibles</h4>
              <input type="text" class="entity-search" id="entity-search" placeholder="Rechercher une entit√©...">
              <div class="create-entity-form">
                <input type="text" class="create-entity-input" id="new-entity-name" placeholder="Nom de la nouvelle entit√©">
                <select class="create-entity-input" id="new-entity-type">
                  <!-- Les types d'entit√©s seront charg√©s dynamiquement depuis le document -->
                </select>
                <button class="create-entity-btn" onclick="createNewCanvasEntity()"><i class="fas fa-plus"></i> Cr√©er</button>
              </div>
              <div id="pdf-selected-text-preview" style="display:none;padding:0.75rem;background:rgba(16,185,129,.1);border:1px dashed var(--pharma-accent);border-radius:8px;margin-bottom:1rem;">
                <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.5rem;color:var(--pharma-accent);">
                  <i class="fas fa-file-pdf"></i> Texte s√©lectionn√© dans le PDF:
                </div>
                <div id="pdf-selected-text-content" style="font-size:0.85rem;max-height:100px;overflow-y:auto;padding:0.5rem;background:#fff;border-radius:4px;"></div>
                <button class="create-entity-btn" onclick="createEntityFromPDFSelection()" style="margin-top:0.5rem;">
                  <i class="fas fa-plus-circle"></i> Cr√©er entit√© depuis s√©lection
                </button>
              </div>
              <div class="entity-list" id="entity-list"></div>
            </div>

            <!-- Contenu: Annotations du document -->
            <div class="palette-content" id="palette-annotations-content" style="display:none;">
              <h4><i class="fas fa-tags"></i> Annotations du document</h4>
              <div class="annotation-selector-container">
                <input type="text" class="annotation-search" id="annotation-search" placeholder="üîç Rechercher une annotation..." onkeyup="filterAnnotations(this.value)">
                <select class="annotation-select" id="annotation-select" size="10" onchange="handleAnnotationSelection(this)">
                  <option value="">-- Chargement des annotations --</option>
                </select>
                <div class="annotation-actions">
                  <button class="annotation-action-btn primary" onclick="addSelectedAnnotationToCanvas()">
                    <i class="fas fa-plus-circle"></i> Ajouter au canvas
                  </button>
                  <button class="annotation-action-btn" onclick="previewAnnotation()">
                    <i class="fas fa-eye"></i> Aper√ßu
                  </button>
                </div>
                <div class="annotation-preview" id="annotation-preview" style="display:none;">
                  <div class="annotation-preview-header">
                    <strong>Aper√ßu:</strong>
                  </div>
                  <div class="annotation-preview-content" id="annotation-preview-content"></div>
                </div>
              </div>
              <div class="annotation-stats" id="annotation-stats">
                <div class="stat-item"><span class="stat-label">Total:</span> <span id="total-annotations">0</span></div>
                <div class="stat-item"><span class="stat-label">Utilis√©es:</span> <span id="used-annotations">0</span></div>
              </div>
            </div>

            <!-- Contenu: JSON -->
            <div class="palette-content" id="palette-json-content" style="display:none;">
              <h4><i class="fas fa-code"></i> JSON Annotations (√âditable)</h4>
              <div class="json-viewer-controls">
                <button class="json-control-btn" onclick="formatJSON()"><i class="fas fa-magic"></i> Formater</button>
                <button class="json-control-btn" onclick="copyJSON()"><i class="fas fa-copy"></i> Copier</button>
                <button class="json-control-btn primary" onclick="saveEditedJSON()"><i class="fas fa-save"></i> Sauvegarder</button>
              </div>
              <div class="json-viewer" id="json-viewer">
                <div id="json-monaco-editor"></div>
              </div>
            </div>
          </div>

        <!-- Panel types relation -->
        <div class="relation-types-panel" id="relation-types-panel">
          <div style="font-weight:600;margin-bottom:.5rem;text-align:center">Choisir le type de relation :</div>
          <div class="relation-type-option" data-type="contains">contient</div>
          <div class="relation-type-option" data-type="manufactured_by">fabriqu√© par</div>
          <div class="relation-type-option" data-type="has_dosage">dosage</div>
          <div class="relation-type-option" data-type="used_for">utilis√© pour</div>
          <div class="relation-type-option" data-type="contraindicated_with">contre-indiqu√©</div>
          <div class="relation-type-option" data-type="interacts_with">interagit avec</div>
          <div class="relation-type-option" data-type="composed_of">compos√© de</div>
          <div class="relation-type-option" data-type="has_side_effect">effet secondaire</div>
          <div class="relation-type-option custom" data-type="__custom"><i class="fas fa-plus"></i> Personnalis√©</div>
        </div>

        <!-- Dialog description -->
        <div id="rel-desc-backdrop" class="relation-desc-backdrop"></div>
        <div id="rel-desc-dialog" class="relation-desc-dialog" role="dialog" aria-modal="true">
          <h5><i class="fas fa-align-left"></i> D√©crire la relation</h5>
          <div id="rel-desc-context" style="font-size:.9rem;color:#475569;margin-bottom:.5rem"></div>
          <textarea id="rel-desc-text" placeholder="Saisissez une description pr√©cise de la relation (optionnel)"></textarea>
          <div class="relation-desc-actions">
            <button class="builder-btn" id="rel-desc-cancel">Annuler</button>
            <button class="builder-btn" id="rel-desc-ai">Laisser l‚ÄôIA</button>
            <button class="builder-btn primary" id="rel-desc-ok"><i class="fas fa-check"></i> Valider</button>
          </div>
        </div>

          <!-- R√©sum√© -->
          <div class="relations-summary" id="relations-summary">
            <div class="summary-title"><i class="fas fa-list"></i> Relations cr√©√©es <span class="relations-count" id="relations-count">0</span></div>
            <div id="relations-preview"></div>
          </div>
        </div> <!-- fin vrb-right-panel -->

      </div> <!-- fin visual-relation-builder -->
    </div>
  </div>
</div>

{# Modales Q&A & paragraphe #}
<div id="add-qa-modal" class="semantic-modal">
  <div class="modal-content-semantic">
    <div class="modal-header-semantic">
      <h3><i class="fas fa-question"></i> Ajouter Question-R√©ponse</h3>
      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('add-qa-modal')">√ó</button>
    </div>
    <div class="modal-body-semantic">
      <div class="form-group"><label class="form-label">Question</label><input type="text" id="qa-question" class="form-control" placeholder="ex: Quel est le dosage du produit ?"></div>
      <div class="form-group"><label class="form-label">R√©ponse</label><textarea id="qa-answer" class="form-control" rows="3" placeholder="R√©ponse compl√®te..."></textarea></div>
      <div class="form-group"><label class="form-label">Tags (optionnel)</label><input type="text" id="qa-tags" class="form-control" placeholder="dosage, posologie, administration"></div>
      <div style="text-align:right;display:flex;gap:1rem;justify-content:flex-end">
        <button class="enrichment-btn secondary" onclick="hideModal('add-qa-modal')">Annuler</button>
        <button class="enrichment-btn primary" onclick="addQAPair()"><i class="fas fa-plus"></i>Ajouter</button>
      </div>
    </div>
  </div>
</div>

{# Modale d'analyse de paragraphe #}
<div id="add-text-modal" class="semantic-modal">
  <div class="modal-content-semantic" style="max-width:900px;">
    <div class="modal-header-semantic">
      <h3><i class="fas fa-paragraph"></i> Analyser un Paragraphe</h3>
      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('add-text-modal')">√ó</button>
    </div>
    <div class="modal-body-semantic" style="padding:2rem;">
      <div class="form-group" style="margin-bottom:1.5rem;">
        <label class="form-label" style="font-weight:600;margin-bottom:0.5rem;display:block;">
          <i class="fas fa-align-left"></i> Paragraphe √† analyser
        </label>
        <textarea id="free-text" class="form-control" rows="8" placeholder="Collez ici le paragraphe √† analyser pour extraire les relations s√©mantiques..." style="font-family:monospace;font-size:0.9rem;line-height:1.6;"></textarea>
      </div>

      <div class="form-group" style="margin-bottom:1.5rem;">
        <label class="form-label" style="font-weight:600;margin-bottom:0.5rem;display:block;">
          <i class="fas fa-lightbulb"></i> Indice contextuel (optionnel)
        </label>
        <input type="text" id="free-text-hint" class="form-control" placeholder="ex: Informations sur les dosages, interactions m√©dicamenteuses..." style="font-size:0.9rem;">
      </div>

      <!-- Actions initiales -->
      <div id="paragraph-initial-actions" style="text-align:right;display:flex;gap:1rem;justify-content:flex-end;">
        <button class="enrichment-btn secondary" onclick="hideModal('add-text-modal')">
          <i class="fas fa-times"></i> Annuler
        </button>
        <button class="enrichment-btn primary" onclick="analyzeParagraph()">
          <i class="fas fa-magic"></i> Analyser les relations
        </button>
      </div>

      <!-- Aper√ßu des relations trouv√©es -->
      <div id="paragraph-relations-preview" style="display:none;margin-top:2rem;">
        <div style="background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(16,185,129,0.1));border:2px solid var(--pharma-primary);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem;">
          <h4 style="color:var(--pharma-primary);margin:0 0 1rem 0;display:flex;align-items:center;gap:0.5rem;">
            <i class="fas fa-check-circle"></i>
            <span id="found-relations-count">0 relation trouv√©e</span>
          </h4>
          <div id="found-relations-list" style="max-height:400px;overflow-y:auto;"></div>
        </div>

        <div style="text-align:right;display:flex;gap:1rem;justify-content:flex-end;">
          <button class="enrichment-btn secondary" onclick="clearParagraphAnalysis()">
            <i class="fas fa-undo"></i> Recommencer
          </button>
          <button class="enrichment-btn secondary" onclick="reAnalyzeParagraph()">
            <i class="fas fa-sync-alt"></i> R√©-analyser
          </button>
          <button class="enrichment-btn primary" onclick="saveParagraphRelations()">
            <i class="fas fa-save"></i> Sauvegarder les relations
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{# Modale d'analyse des documents valid√©s page par page #}
<div id="document-page-analysis-modal" class="semantic-modal">
  <div class="modal-content-semantic">
    <div class="modal-header-semantic">
      <h3><i class="fas fa-file-medical-alt"></i> Analyser les Relations dans les Documents Valid√©s</h3>
      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('document-page-analysis-modal')">√ó</button>
    </div>
    <div class="modal-body-semantic" style="max-height:80vh;overflow-y:auto;padding:2rem;">

      <!-- √âtape 1: S√©lection du document -->
      <div id="doc-selection-step" class="analysis-step">
        <h4 style="color:var(--pharma-primary);margin-bottom:1.5rem;">
          <i class="fas fa-book"></i> √âtape 1 : S√©lectionnez un document valid√©
        </h4>

        <!-- Filtre de recherche -->
        <div style="margin-bottom:1.5rem;">
          <input
            type="text"
            id="doc-search-filter"
            class="form-control"
            placeholder="üîç Rechercher par titre, type, source, pays..."
            onkeyup="filterValidatedDocuments(this.value)"
            style="padding:0.75rem;border:2px solid var(--pharma-border);border-radius:8px;font-size:0.95rem;">
        </div>

        <!-- Liste des documents valid√©s -->
        <div id="validated-documents-list" style="max-height:400px;overflow-y:auto;">
          <div style="text-align:center;padding:3rem;color:var(--pharma-text-soft);">
            <i class="fas fa-spinner fa-spin" style="font-size:2rem;margin-bottom:1rem;"></i>
            <p>Chargement des documents valid√©s...</p>
          </div>
        </div>
      </div>

      <!-- √âtape 2: S√©lection de la page -->
      <div id="page-selection-step" class="analysis-step" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
          <h4 style="color:var(--pharma-primary);margin:0;">
            <i class="fas fa-file-alt"></i> √âtape 2 : S√©lectionnez une page
          </h4>
          <button class="enrichment-btn secondary" onclick="backToDocumentSelection()">
            <i class="fas fa-arrow-left"></i> Retour
          </button>
        </div>

        <!-- Info du document s√©lectionn√© -->
        <div id="selected-doc-info" style="background:linear-gradient(135deg,rgba(59,130,246,.08),rgba(16,185,129,.08));border-radius:12px;padding:1.5rem;margin-bottom:1.5rem;">
          <div style="display:flex;align-items:center;gap:1rem;">
            <div style="width:48px;height:48px;background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;">
              <i class="fas fa-file-pdf"></i>
            </div>
            <div style="flex:1;">
              <div id="selected-doc-title" style="font-weight:700;font-size:1.1rem;color:var(--pharma-text);margin-bottom:0.25rem;"></div>
              <div id="selected-doc-meta" style="font-size:0.85rem;color:var(--pharma-text-soft);"></div>
            </div>
          </div>
        </div>

        <!-- Options d'analyse -->
        <div style="background:#fff;border:2px solid var(--pharma-border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem;">
          <div style="display:flex;gap:2rem;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.95rem;">
              <input type="radio" name="page-selection-mode" value="single" checked onchange="updatePageSelectionMode(this.value)">
              <i class="fas fa-file"></i> Page unique
            </label>
            <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.95rem;">
              <input type="radio" name="page-selection-mode" value="multiple" onchange="updatePageSelectionMode(this.value)">
              <i class="fas fa-layer-group"></i> Pages multiples
            </label>
            <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.95rem;">
              <input type="radio" name="page-selection-mode" value="all" onchange="updatePageSelectionMode(this.value)">
              <i class="fas fa-book-open"></i> Toutes les pages
            </label>
          </div>
        </div>

        <!-- Liste des pages -->
        <div id="document-pages-list" style="max-height:350px;overflow-y:auto;">
          <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft);">
            <i class="fas fa-spinner fa-spin" style="font-size:1.5rem;"></i>
          </div>
        </div>

        <div style="text-align:right;margin-top:1.5rem;">
          <button class="enrichment-btn primary" onclick="analyzeSelectedPages()" id="analyze-pages-btn">
            <i class="fas fa-magic"></i> Analyser les relations
          </button>
        </div>
      </div>

      <!-- √âtape 3: R√©sultats de l'analyse -->
      <div id="analysis-results-step" class="analysis-step" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
          <h4 style="color:var(--pharma-primary);margin:0;">
            <i class="fas fa-chart-line"></i> R√©sultats de l'analyse
          </h4>
          <button class="enrichment-btn secondary" onclick="backToPageSelection()">
            <i class="fas fa-arrow-left"></i> Retour
          </button>
        </div>

        <!-- Statistiques globales -->
        <div id="analysis-stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem;">
        </div>

        <!-- Relations trouv√©es par page -->
        <div id="page-relations-container">
          <div style="text-align:center;padding:3rem;color:var(--pharma-text-soft);">
            <i class="fas fa-spinner fa-spin" style="font-size:2rem;margin-bottom:1rem;"></i>
            <p>Analyse en cours...</p>
          </div>
        </div>

        <div style="text-align:right;margin-top:1.5rem;display:flex;gap:1rem;justify-content:flex-end;">
          <button class="enrichment-btn secondary" onclick="exportAnalysisResults()">
            <i class="fas fa-download"></i> Exporter JSON
          </button>
          <button class="enrichment-btn primary" onclick="addAnalysisToDocument()">
            <i class="fas fa-save"></i> Ajouter au document
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

{# Modale d'√©dition/ajout de relation #}
<div id="edit-relation-modal" class="semantic-modal">
  <div class="modal-content-semantic" style="max-width:700px;max-height:90vh;display:flex;flex-direction:column;">
    <div class="modal-header-semantic">
      <h3><i class="fas fa-edit"></i> Modifier la relation</h3>
      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('edit-relation-modal')">√ó</button>
    </div>
    <div class="modal-body-semantic" style="padding:2rem;overflow-y:auto;flex:1;">
      <div style="display:grid;grid-template-columns:1fr;gap:1.5rem;">

        <!-- Entit√© Source -->
        <div style="background:rgba(59,130,246,0.05);border:2px solid rgba(59,130,246,0.2);border-radius:12px;padding:1.5rem;">
          <h4 style="color:var(--pharma-primary);margin:0 0 1rem 0;font-size:1rem;">
            <i class="fas fa-circle" style="font-size:0.5rem;"></i> Entit√© Source
          </h4>
          <div style="display:grid;gap:1rem;">
            <div>
              <label class="form-label" style="font-weight:600;margin-bottom:0.5rem;display:block;">Valeur</label>
              <input type="text" id="edit-source-value" class="form-control" placeholder="Ex: Parac√©tamol" style="padding:0.75rem;border:2px solid var(--pharma-border);border-radius:8px;width:100%;">
            </div>
            <div>
              <label class="form-label" style="font-weight:600;margin-bottom:0.5rem;display:block;">Type</label>
              <select id="edit-source-type" class="form-control" style="padding:0.75rem;border:2px solid var(--pharma-border);border-radius:8px;width:100%;">
                <option value="product">Produit</option>
                <option value="ingredient">Ingr√©dient</option>
                <option value="dosage">Dosage</option>
                <option value="indication">Indication</option>
                <option value="contraindication">Contre-indication</option>
                <option value="authority">Autorit√©</option>
                <option value="procedure">Proc√©dure</option>
                <option value="regulation">R√©gulation</option>
                <option value="organization">Organisation</option>
                <option value="other">Autre</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Type de relation -->
        <div style="text-align:center;">
          <div style="display:inline-flex;align-items:center;gap:1rem;background:#fff;padding:1rem 2rem;border-radius:12px;border:2px solid var(--pharma-border);">
            <i class="fas fa-arrow-right" style="color:var(--pharma-accent);font-size:1.5rem;"></i>
            <div style="text-align:left;">
              <label class="form-label" style="font-weight:600;margin-bottom:0.5rem;display:block;font-size:0.9rem;">Type de relation</label>
              <input type="text" id="edit-relation-type" class="form-control" placeholder="Ex: contains, manufactured_by" style="padding:0.75rem;border:2px solid var(--pharma-border);border-radius:8px;min-width:250px;">
            </div>
          </div>
        </div>

        <!-- Entit√© Cible -->
        <div style="background:rgba(16,185,129,0.05);border:2px solid rgba(16,185,129,0.2);border-radius:12px;padding:1.5rem;">
          <h4 style="color:var(--pharma-accent);margin:0 0 1rem 0;font-size:1rem;">
            <i class="fas fa-circle" style="font-size:0.5rem;"></i> Entit√© Cible
          </h4>
          <div style="display:grid;gap:1rem;">
            <div>
              <label class="form-label" style="font-weight:600;margin-bottom:0.5rem;display:block;">Valeur</label>
              <input type="text" id="edit-target-value" class="form-control" placeholder="Ex: Aspirine" style="padding:0.75rem;border:2px solid var(--pharma-border);border-radius:8px;width:100%;">
            </div>
            <div>
              <label class="form-label" style="font-weight:600;margin-bottom:0.5rem;display:block;">Type</label>
              <select id="edit-target-type" class="form-control" style="padding:0.75rem;border:2px solid var(--pharma-border);border-radius:8px;width:100%;">
                <option value="product">Produit</option>
                <option value="ingredient">Ingr√©dient</option>
                <option value="dosage">Dosage</option>
                <option value="indication">Indication</option>
                <option value="contraindication">Contre-indication</option>
                <option value="authority">Autorit√©</option>
                <option value="procedure">Proc√©dure</option>
                <option value="regulation">R√©gulation</option>
                <option value="organization">Organisation</option>
                <option value="other">Autre</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div>
          <label class="form-label" style="font-weight:600;margin-bottom:0.5rem;display:block;">
            <i class="fas fa-align-left"></i> Description (optionnelle)
          </label>
          <textarea id="edit-relation-description" class="form-control" rows="3" placeholder="Description d√©taill√©e de la relation..." style="padding:0.75rem;border:2px solid var(--pharma-border);border-radius:8px;width:100%;resize:vertical;"></textarea>
        </div>

        <!-- Actions -->
        <div style="display:flex;gap:1rem;justify-content:flex-end;margin-top:1rem;">
          <button class="enrichment-btn secondary" onclick="hideModal('edit-relation-modal')">
            <i class="fas fa-times"></i> Annuler
          </button>
          <button class="enrichment-btn primary" onclick="saveEditedRelation()">
            <i class="fas fa-save"></i> Sauvegarder
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  /* =================== Utils =================== */
  function fromJsonScript(id, fallback) {
    const n = document.getElementById(id);
    if (!n) return fallback;
    try { return JSON.parse(n.textContent.trim() || '{}'); }
    catch (e) { console.warn('JSON invalide pour', id, e); return fallback; }
  }

  function getCookie(name) {
    const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  window.getCookie = getCookie;

  function notify(msg, type) {
    const el = document.createElement('div');
    el.className = `expert-notification ${type || 'info'}`;
    el.innerHTML = `<div class="notification-content">
      <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
      <span>${msg}</span>
    </div>`;
    if (!document.getElementById('expert-notification-styles')) {
      const css = document.createElement('style'); css.id = 'expert-notification-styles';
      css.textContent =
        `.expert-notification{position:fixed;top:20px;right:20px;z-index:10000;padding:1rem 1.5rem;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.15);backdrop-filter:blur(10px);animation:slideIn .25s ease-out;max-width:400px}
         .expert-notification.success{background:linear-gradient(135deg,rgba(16,185,129,.9),rgba(34,197,94,.9));color:#fff}
         .expert-notification.error{background:linear-gradient(135deg,rgba(239,68,68,.9),rgba(220,38,38,.9));color:#fff}
         .expert-notification.info{background:linear-gradient(135deg,rgba(59,130,246,.9),rgba(16,185,129,.9));color:#fff}
         .notification-content{display:flex;align-items:center;gap:.75rem;font-weight:500;font-size:.9rem}
         @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
         @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}`;
      document.head.appendChild(css);
    }
    document.body.appendChild(el);
    setTimeout(() => { el.style.animation = 'slideOut .25s ease-in'; setTimeout(() => el.remove(), 280); }, 3000);
  }
  window.notify = notify;

  /* =================== Donn√©es =================== */
  const BASIC    = fromJsonScript('basic-json-data',   {});
  const ENRICHED = fromJsonScript('enriched-json-data',{});
  const DISPLAY  = fromJsonScript('display-json-data', {});

  /* =================== Visual builder state =================== */
  let allEntities = [];
  let canvasEntities = [];
  let canvasRelations = [];
  let currentMode = 'connect';
  let connectionState = { from: null, to: null };
  let pendingRelation = null; // pour le dialogue de description

  const RELATION_LABELS = {
    contains: 'contient',
    manufactured_by: 'est fabriqu√© par',
    has_dosage: 'a pour dosage',
    used_for: 'est utilis√© pour',
    contraindicated_with: 'est contre-indiqu√© avec',
    interacts_with: 'interagit avec',
    composed_of: 'est compos√© de',
    has_side_effect: 'a pour effet secondaire'
  };

  /* =================== Monaco =================== */
  require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs' } });

  function makeEditor(id, val, readOnly) {
    const el = document.getElementById(id); if (!el) return null;
    return monaco.editor.create(el, {
      value: JSON.stringify(val ?? {}, null, 2),
      language: 'json', theme: 'vs', readOnly: !!readOnly,
      automaticLayout: true, minimap: { enabled: false }, wordWrap: 'on', scrollBeyondLastLine: false
    });
  }
  let basicEditor = null, enrichedEditor = null, jsonMonacoEditor = null;

  document.addEventListener('DOMContentLoaded', function () {
    // Tabs
    document.querySelectorAll('.mode-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const mode = tab.dataset.mode;
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.toggle('active', t === tab));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = (c.id === mode + '-tab') ? 'block' : 'none');
        [basicEditor, enrichedEditor].forEach(ed => ed && ed.layout && ed.layout());
      });
    });

    // Monaco init
    require(['vs/editor/editor.main'], function () {
      basicEditor    = makeEditor('basic-json-editor',    BASIC,    true);
      enrichedEditor = makeEditor('enriched-json-editor', ENRICHED, false);
      if (enrichedEditor && (!ENRICHED || Object.keys(ENRICHED).length === 0)) {
        enrichedEditor.setValue('// Pas encore enrichi. Cliquez sur ¬´ R√©g√©n√©rer ¬ª pour cr√©er le JSON enrichi.');
      }
    });

    // Init entit√©s & stats
    extractAllEntities(BASIC);
    loadLearningStats();
  });

  /* =================== Entit√©s =================== */
  function extractAllEntities(basicJson) {
    allEntities = [];
    const entities = (basicJson && basicJson.entities) || {};
    Object.entries(entities).forEach(([type, items]) => {
      const list = Array.isArray(items) ? items : ((items && items.items) || []);
      list.forEach(item => {
        const value = (typeof item === 'string') ? item : ((item && item.value) || '');
        if (value) allEntities.push({ id: genId(), type, value, x: 0, y: 0 });
      });
    });
  }
  function genId(){ return 'ent_' + Math.random().toString(36).slice(2,10); }

  /* =================== Builder =================== */
  function showVisualRelationBuilder() {
    showModal('visual-relation-modal');
    setTimeout(() => initializeVisualBuilder(), 50);
  }
  window.showVisualRelationBuilder = showVisualRelationBuilder;

  function initializeVisualBuilder() {
    // R√©initialiser les √©tats
    canvasEntities = [];
    canvasRelations = [];

    setupBuilderModes();
    populateEntityTypeSelect();  // Peupler les types d'entit√©s dynamiquement
    populateEntityList();
    loadExistingRelations();
    setupCanvasInteractions();
    renderConnections();
    wireRelationTypePanel();
    wireDescriptionDialog();

    // Initialiser Monaco Editor pour le JSON
    if (!jsonMonacoEditor) {
      require(['vs/editor/editor.main'], function () {
        const el = document.getElementById('json-monaco-editor');
        if (el) {
          jsonMonacoEditor = monaco.editor.create(el, {
            value: JSON.stringify(BASIC || {}, null, 2),
            language: 'json',
            theme: 'vs',
            automaticLayout: true,
            minimap: { enabled: false },
            wordWrap: 'on',
            scrollBeyondLastLine: false,
            fontSize: 13,
            lineNumbers: 'on',
            renderWhitespace: 'selection',
            formatOnPaste: true,
            formatOnType: true
          });
          currentJSON = BASIC || {};
        }
      });
    } else {
      // Mettre √† jour la valeur si l'√©diteur existe d√©j√†
      jsonMonacoEditor.setValue(JSON.stringify(BASIC || {}, null, 2));
      currentJSON = BASIC || {};
    }
    resizeVisualBuilder();
  }

  function loadExistingRelations() {
    const enrichedData = ENRICHED || {};
    const existingRelations = enrichedData.relations || [];

    if (existingRelations.length === 0) return;

    // Convertir les relations JSON en format canvas
    existingRelations.forEach(relationData => {
      const sourceEntity = findOrCreateEntityForRelation(relationData.source);
      const targetEntity = findOrCreateEntityForRelation(relationData.target);

      if (sourceEntity && targetEntity) {
        const canvasRelation = {
          id: relationData.id || genId(),
          source: sourceEntity,
          target: targetEntity,
          type: relationData.type,
          description: relationData.description,
          isExisting: true,
          createdBy: relationData.created_by || 'ai'
        };

        canvasRelations.push(canvasRelation);
      }
    });

    // Auto-positionner les entit√©s
    if (canvasRelations.length > 0) {
      autoArrangeWithRelations();
      updateRelationsSummary();
      notify(`${canvasRelations.length} relations existantes charg√©es`, 'success');
    }
  }

  function findOrCreateEntityForRelation(entityData) {
    // Chercher d'abord dans les entit√©s existantes
    let entity = allEntities.find(e =>
      e.type === entityData.type && e.value === entityData.value
    );

    if (!entity) {
      // Cr√©er l'entit√© si elle n'existe pas
      entity = {
        id: genId(),
        type: entityData.type,
        value: entityData.value,
        x: 0,
        y: 0
      };
      allEntities.push(entity);
    }

    // Ajouter au canvas si pas d√©j√† pr√©sente
    let canvasEntity = canvasEntities.find(e => e.id === entity.id);
    if (!canvasEntity) {
      canvasEntity = { ...entity };
      canvasEntities.push(canvasEntity);
      canvasEntity.x = Math.random() * 400 + 50;
      canvasEntity.y = Math.random() * 300 + 50;
      renderEntityOnCanvas(canvasEntity);
    }

    return canvasEntity;
  }

  function setupBuilderModes() {
    document.querySelectorAll('.mode-switch').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mode-switch').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMode = btn.dataset.mode;
        updateCanvasCursor();
      });
    });
    updateCanvasCursor();
  }
  function updateCanvasCursor() {
    const canvas = document.getElementById('visual-canvas');
    canvas.style.cursor = currentMode === 'connect' ? 'crosshair' : 'default';
  }

  // Peupler le select des types d'entit√©s dynamiquement depuis le JSON
  function populateEntityTypeSelect() {
    const typeSelect = document.getElementById('new-entity-type');
    if (!typeSelect) return;

    // R√©cup√©rer tous les types d'entit√©s depuis BASIC.entities
    const entityTypes = [];
    const basicData = BASIC || {};
    if (basicData.entities && typeof basicData.entities === 'object') {
      Object.keys(basicData.entities).forEach(type => {
        if (type && !entityTypes.includes(type)) {
          entityTypes.push(type);
        }
      });
    }

    // Trier par ordre alphab√©tique
    entityTypes.sort();

    // Vider le select
    typeSelect.innerHTML = '';

    // Ajouter les types d'entit√©s trouv√©s
    if (entityTypes.length > 0) {
      entityTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = formatEntityTypeName(type);
        typeSelect.appendChild(option);
      });
    } else {
      // Si aucune entit√© n'existe, ajouter des types par d√©faut
      const defaultTypes = ['product', 'ingredient', 'dosage', 'indication', 'contraindication'];
      defaultTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = formatEntityTypeName(type);
        typeSelect.appendChild(option);
      });
    }

    // Ajouter option "Personnalis√©" √† la fin
    const customOption = document.createElement('option');
    customOption.value = 'custom';
    customOption.textContent = '+ Nouveau type personnalis√©';
    typeSelect.appendChild(customOption);
  }

  // Formater le nom d'affichage du type d'entit√©
  function formatEntityTypeName(type) {
    const typeNames = {
      'product': 'Produit',
      'ingredient': 'Ingr√©dient',
      'dosage': 'Dosage',
      'indication': 'Indication',
      'contraindication': 'Contre-indication',
      'side_effect': 'Effet secondaire',
      'manufacturer': 'Fabricant',
      'active_ingredient': 'Principe actif',
      'excipient': 'Excipient',
      'posology': 'Posologie',
      'precaution': 'Pr√©caution',
      'interaction': 'Interaction',
      'custom': 'Personnalis√©'
    };
    return typeNames[type] || type.charAt(0).toUpperCase() + type.slice(1).replace(/_/g, ' ');
  }

  function populateEntityList() {
    const list = document.getElementById('entity-list');
    list.innerHTML = '';
    allEntities.forEach(entity => {
      const item = document.createElement('div');
      item.className = 'entity-item';
      item.draggable = true;
      item.innerHTML = `<span>${entity.value}</span><span class="entity-type-label">${entity.type}</span>`;
      item.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', JSON.stringify(entity));
      });
      list.appendChild(item);
    });

    // Recherche
    const search = document.getElementById('entity-search');
    search.oninput = (e) => {
      const q = e.target.value.toLowerCase();
      Array.from(list.children).forEach(it => it.style.display = it.textContent.toLowerCase().includes(q) ? 'flex' : 'none');
    };
  }

  window.createNewCanvasEntity = function createNewCanvasEntity() {
    const nameInput = document.getElementById('new-entity-name');
    const typeSelect = document.getElementById('new-entity-type');
    const name = nameInput.value.trim();
    let type = typeSelect.value;

    if (!name) {
      nameInput.focus();
      return;
    }

    // Si type personnalis√©, demander le nom du type
    if (type === 'custom') {
      const customType = prompt('Entrez le nom du nouveau type d\'entit√© (ex: "fabricant", "effet_secondaire"):');
      if (!customType || !customType.trim()) {
        notify('Type personnalis√© annul√©', 'info');
        return;
      }
      type = customType.trim().toLowerCase().replace(/\s+/g, '_');
    }

    const existingEntity = allEntities.find(e =>
      e.type === type && e.value.toLowerCase() === name.toLowerCase()
    );

    if (existingEntity) {
      notify(`L'entit√© "${name}" existe d√©j√†`, 'warning');
      nameInput.value = '';
      return;
    }

    const entity = {
      id: genId(),
      type,
      value: name,
      x: 0,
      y: 0
    };

    allEntities.push(entity);
    populateEntityList();

    // Ajouter l'entit√© au JSON BASIC
    if (!BASIC.entities) {
      BASIC.entities = {};
    }
    if (!BASIC.entities[type]) {
      BASIC.entities[type] = [];
      // Si c'est un nouveau type, mettre √† jour le select
      populateEntityTypeSelect();
    }
    BASIC.entities[type].push({
      value: name,
      confidence: 1.0,
      created_by: 'expert'
    });

    // Mettre √† jour l'affichage du JSON dans Monaco Editor
    currentJSON = BASIC;
    if (jsonMonacoEditor) {
      jsonMonacoEditor.setValue(JSON.stringify(BASIC, null, 2));
    }

    nameInput.value = '';
    notify(`Entit√© ¬´ ${name} ¬ª cr√©√©e et ajout√©e au JSON`, 'success');
  };

  function setupCanvasInteractions() {
    const canvas = document.getElementById('visual-canvas');

    // Drop pour ajouter une entit√©
    canvas.addEventListener('dragover', e => e.preventDefault());
    canvas.addEventListener('drop', (e) => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      try {
        const entityData = JSON.parse(e.dataTransfer.getData('text/plain'));
        addEntityToCanvas(entityData, x, y);
      } catch (err) { console.warn('Drop error:', err); }
    });

    // Click de connexion
    canvas.addEventListener('click', (e) => {
      if (currentMode !== 'connect') return;
      const point = e.target.closest('.connection-point');
      if (!point) return;
      const entityId = point.dataset.entityId;
      const entity = canvasEntities.find(en => en.id === entityId);
      if (!entity) return;

      if (!connectionState.from) {
        connectionState.from = entity;
        document.getElementById(entity.id)?.classList.add('connecting');
        notify('Cliquez sur une autre entit√© pour choisir la cible', 'info');
      } else if (connectionState.from.id === entityId) {
        clearConnectionState();
      } else {
        connectionState.to = entity;
        showRelationTypesPanel();
      }
    });
  }

  function autoArrangeWithRelations() {
    if (canvasEntities.length === 0) return;

    const canvas = document.getElementById('visual-canvas');
    const width = canvas.offsetWidth - 200;
    const height = canvas.offsetHeight - 100;

    if (canvasRelations.length > 0) {
      layoutWithForces(width, height);
    } else {
      layoutCircular(width, height);
    }

    renderConnections();
  }

  function layoutWithForces(width, height) {
    const centerX = width / 2;
    const centerY = height / 2;

    // Grouper les entit√©s par connectivit√©
    const entityGroups = new Map();
    const visited = new Set();

    // Fonction pour trouver tous les n≈ìuds connect√©s
    function findConnectedGroup(entity, group) {
      if (visited.has(entity.id)) return;
      visited.add(entity.id);
      group.add(entity);

      // Trouver toutes les relations connect√©es
      canvasRelations.forEach(rel => {
        if (rel.source.id === entity.id && !visited.has(rel.target.id)) {
          findConnectedGroup(rel.target, group);
        }
        if (rel.target.id === entity.id && !visited.has(rel.source.id)) {
          findConnectedGroup(rel.source, group);
        }
      });
    }

    // Cr√©er les groupes
    canvasEntities.forEach(entity => {
      if (!visited.has(entity.id)) {
        const group = new Set();
        findConnectedGroup(entity, group);
        entityGroups.set(entity.id, Array.from(group));
      }
    });

    // Organiser chaque groupe
    const groups = Array.from(new Set(Array.from(entityGroups.values()).map(g => g[0])));
    const numGroups = groups.length;

    groups.forEach((groupLeader, groupIndex) => {
      const group = entityGroups.get(groupLeader.id);
      const groupSize = group.length;

      // Position centrale du groupe sur un cercle
      const groupAngle = (groupIndex / numGroups) * 2 * Math.PI;
      const groupRadius = Math.min(width, height) * 0.25;
      const groupCenterX = centerX + Math.cos(groupAngle) * groupRadius;
      const groupCenterY = centerY + Math.sin(groupAngle) * groupRadius;

      // Organiser les entit√©s du groupe en cercle autour du centre
      const entityRadius = 80;
      group.forEach((entity, index) => {
        const entityAngle = (index / groupSize) * 2 * Math.PI;
        entity.x = groupCenterX + Math.cos(entityAngle) * entityRadius;
        entity.y = groupCenterY + Math.sin(entityAngle) * entityRadius;

        // Contraindre dans les limites
        entity.x = Math.max(80, Math.min(entity.x, width - 80));
        entity.y = Math.max(40, Math.min(entity.y, height - 40));

        const element = document.getElementById(entity.id);
        if (element) {
          element.style.left = entity.x + 'px';
          element.style.top = entity.y + 'px';
        }
      });
    });
  }

  function layoutCircular(width, height) {
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) * 0.35;
    const angleStep = (2 * Math.PI) / canvasEntities.length;

    canvasEntities.forEach((entity, index) => {
      const angle = index * angleStep;
      entity.x = centerX + radius * Math.cos(angle) - 60;
      entity.y = centerY + radius * Math.sin(angle) - 25;

      const element = document.getElementById(entity.id);
      if (element) {
        element.style.left = entity.x + 'px';
        element.style.top = entity.y + 'px';
      }
    });
  }

  function addEntityToCanvas(entity, x, y) {
    if (canvasEntities.find(e => e.id === entity.id)) {
      notify('Cette entit√© est d√©j√† sur le canvas', 'warning');
      return;
    }
    const canvasEntity = { ...entity, x, y };
    canvasEntities.push(canvasEntity);
    renderEntityOnCanvas(canvasEntity);
  }

  function renderEntityOnCanvas(entity) {
    const canvas = document.getElementById('visual-canvas');
    const element = document.createElement('div');
    element.className = 'canvas-entity';

    // Ajouter une classe si l'entit√© a des relations existantes
    const hasExistingRelations = canvasRelations.some(rel =>
      (rel.source.id === entity.id || rel.target.id === entity.id) && rel.isExisting
    );
    if (hasExistingRelations) {
      element.classList.add('has-existing-relations');
    }

    element.id = entity.id;
    element.textContent = entity.value;
    element.title = `${entity.type}: ${entity.value}`;
    element.style.left = entity.x + 'px';
    element.style.top  = entity.y + 'px';

    const rightPoint = document.createElement('div');
    rightPoint.className = 'connection-point right';
    rightPoint.dataset.entityId = entity.id;
    rightPoint.dataset.side = 'right';

    const leftPoint = document.createElement('div');
    leftPoint.className = 'connection-point left';
    leftPoint.dataset.entityId = entity.id;
    leftPoint.dataset.side = 'left';

    element.appendChild(rightPoint);
    element.appendChild(leftPoint);

    makeDraggable(element, entity);
    canvas.appendChild(element);
  }

  function makeDraggable(element, entity) {
    let isDragging = false;
    let startX, startY;

    element.addEventListener('mousedown', (e) => {
      if (currentMode !== 'move') return;
      isDragging = true;
      startX = e.clientX - entity.x;
      startY = e.clientY - entity.y;
      element.classList.add('dragging');
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      entity.x = e.clientX - startX;
      entity.y = e.clientY - startY;
      const canvas = document.getElementById('visual-canvas');
      const maxX = canvas.offsetWidth  - element.offsetWidth;
      const maxY = canvas.offsetHeight - element.offsetHeight;
      entity.x = Math.max(0, Math.min(entity.x, maxX));
      entity.y = Math.max(0, Math.min(entity.y, maxY));
      element.style.left = entity.x + 'px';
      element.style.top  = entity.y + 'px';
      renderConnections();
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) { isDragging = false; element.classList.remove('dragging'); }
    });
  }

  /* ========= Panneau types de relation ========= */
  function wireRelationTypePanel() {
    const panel = document.getElementById('relation-types-panel');
    if (panel.__wired) return; panel.__wired = true;
    panel.addEventListener('click', (e) => {
      const opt = e.target.closest('.relation-type-option');
      if (!opt) return;
      let relType = opt.dataset.type;
      if (relType === '__custom') {
        const customType = prompt('Saisissez le type de relation personnalis√©:');
        if (!customType || !customType.trim()) return;
        relType = customType.trim().toLowerCase().replace(/\s+/g, '_');
      }
      // On ouvre le dialogue de description
      openDescriptionDialog(relType);
      hideRelationTypesPanel();
    });
  }

  function centerRelationPanel() {
    const panel   = document.getElementById('relation-types-panel');
    const builder = document.querySelector('.visual-relation-builder');
    const palette = document.querySelector('.entity-palette');
    const summary = document.getElementById('relations-summary');
    if (!panel || !builder) return;

    // hauteur du r√©sum√© pour √©viter le chevauchement
    const sumH = summary ? summary.offsetHeight : 72;
    builder.style.setProperty('--vrb-summary-h', sumH + 'px');

    // Centre sur la zone canvas (builder total - palette)
    const bRect = builder.getBoundingClientRect();
    const pRect = palette ? palette.getBoundingClientRect() : { width:0, left:bRect.right };
    const usableWidth = (pRect.left - bRect.left) - 32; // marge
    const centerX = bRect.left + usableWidth/2;
    panel.style.left = centerX + 'px';
    panel.style.transform = 'translateX(-50%)';
  }

  function showRelationTypesPanel(){
    const panel = document.getElementById('relation-types-panel');
    panel.classList.add('show');
    centerRelationPanel();
  }
  function hideRelationTypesPanel(){ document.getElementById('relation-types-panel').classList.remove('show'); }

  /* ========= Description par l‚Äôutilisateur ========= */
  function wireDescriptionDialog(){
    const dlg = document.getElementById('rel-desc-dialog');
    const bg  = document.getElementById('rel-desc-backdrop');
    const ok  = document.getElementById('rel-desc-ok');
    const ai  = document.getElementById('rel-desc-ai');
    const cancel = document.getElementById('rel-desc-cancel');
    ok.onclick = () => {
      const txt = (document.getElementById('rel-desc-text').value || '').trim();
      if (pendingRelation) pendingRelation.description = txt || undefined;
      closeDescriptionDialog(true);
      finalizeCreateRelation();
    };

    ai.onclick = async () => {
      if (!pendingRelation) return;

      const textArea = document.getElementById('rel-desc-text');
      ai.disabled = true;
      ai.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...';

      try {
        const aiDescription = await generateSingleRelationDescription(pendingRelation);
        if (aiDescription) {
          textArea.value = aiDescription;
          notify('‚úÖ Description g√©n√©r√©e par l\'IA - Vous pouvez la modifier', 'success');
        } else {
          textArea.value = simpleAutodescribe(pendingRelation);
          notify('Description g√©n√©r√©e automatiquement', 'info');
        }
      } catch (e) {
        console.warn('Erreur g√©n√©ration IA:', e);
        textArea.value = simpleAutodescribe(pendingRelation);
        notify('Description g√©n√©r√©e automatiquement (fallback)', 'info');
      } finally {
        ai.disabled = false;
        ai.innerHTML = '<i class="fas fa-magic"></i> Laisser l\'IA';
      }
    };

    cancel.onclick = () => { pendingRelation = null; closeDescriptionDialog(false); clearConnectionState(); };
    bg.onclick = cancel.onclick;
  }

  async function generateSingleRelationDescription(relation) {
    try {
      const response = await fetch(`/expert/document/{{ document.id }}/describe-relation/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          source_type: relation.source.type,
          source_value: relation.source.value,
          relation_type: relation.type,
          target_type: relation.target.type,
          target_value: relation.target.value,
          context: 'visual_builder'
        })
      });

      if (response.ok) {
        const data = await response.json();
        return data.success ? data.description : null;
      }
    } catch (e) {
      console.warn('Erreur API description:', e);
    }
    return null;
  }

  function openDescriptionDialog(relType){
    if (!connectionState.from || !connectionState.to) return;
    pendingRelation = { id: genId(), source: connectionState.from, target: connectionState.to, type: relType, description: undefined };
    const dlg = document.getElementById('rel-desc-dialog');
    const bg  = document.getElementById('rel-desc-backdrop');
    const ctx = document.getElementById('rel-desc-context');
    const txt = document.getElementById('rel-desc-text');
    ctx.textContent = `${connectionState.from.value} ‚Äî ${(RELATION_LABELS[relType]||relType).replace(/_/g,' ')} ‚Äî ${connectionState.to.value}`;
    txt.value = '';
    dlg.classList.add('show'); bg.classList.add('show');
  }
  function closeDescriptionDialog(){
    document.getElementById('rel-desc-dialog').classList.remove('show');
    document.getElementById('rel-desc-backdrop').classList.remove('show');
  }
  function finalizeCreateRelation(){
    if (!pendingRelation) return;
    canvasRelations.push(pendingRelation);
    clearConnectionState();
    renderConnections();
    updateRelationsSummary();
    const verb = (RELATION_LABELS[pendingRelation.type]||pendingRelation.type).replace(/_/g,' ');
    notify(`Relation ¬´ ${verb} ¬ª cr√©√©e`, 'success');
    pendingRelation = null;
  }

  function clearConnectionState() {
    document.querySelectorAll('.canvas-entity').forEach(el => el.classList.remove('connecting'));
    connectionState = { from: null, to: null };
  }

  /* =================== Rendu des connexions =================== */
  function clearSVGExceptDefs(svg) {
    Array.from(svg.childNodes).forEach(n => {
      if (!(n.nodeName && n.nodeName.toLowerCase() === 'defs')) svg.removeChild(n);
    });
  }

  function renderConnections() {
    const svg = document.getElementById('connection-svg');
    if (!svg) return;
    clearSVGExceptDefs(svg);

    canvasRelations.forEach(relation => {
      const sEl = document.getElementById(relation.source.id);
      const tEl = document.getElementById(relation.target.id);
      if (!(sEl && tEl)) return;

      const sRect = sEl.getBoundingClientRect();
      const tRect = tEl.getBoundingClientRect();
      const svgRect = svg.getBoundingClientRect();

      const startX = sRect.right - svgRect.left;
      const startY = sRect.top + sRect.height/2 - svgRect.top;
      const endX   = tRect.left  - svgRect.left;
      const endY   = tRect.top + tRect.height/2 - svgRect.top;

      const c1x = startX + (endX - startX) * 0.5;
      const c1y = startY;
      const c2x = startX + (endX - startX) * 0.5;
      const c2y = endY;

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', `M ${startX} ${startY} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${endX} ${endY}`);

      // Style diff√©rent selon le type de relation
      const isExisting = relation.isExisting;
      const strokeColor = isExisting ? '#10b981' : '#3b82f6';
      const strokeWidth = isExisting ? '2.5' : '2';
      const strokeDasharray = isExisting ? 'none' : '5,3';

      path.setAttribute('stroke', strokeColor);
      path.setAttribute('stroke-width', strokeWidth);
      path.setAttribute('stroke-dasharray', strokeDasharray);
      path.setAttribute('fill', 'none');
      path.setAttribute('marker-end', 'url(#arrowhead)');
      path.style.filter = `drop-shadow(0 1px 3px rgba(${isExisting ? '16, 185, 129' : '59, 130, 246'}, 0.4))`;
      path.style.cursor = 'pointer';
      path.title = `${relation.source.value} ‚Üí ${relation.target.value}${relation.description ? '\n' + relation.description : ''}`;
      svg.appendChild(path);

      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      label.setAttribute('x', (startX + endX)/2);
      label.setAttribute('y', (startY + endY)/2 - 8);
      label.setAttribute('text-anchor', 'middle');
      label.setAttribute('fill', 'var(--pharma-text)');
      label.setAttribute('font-size', '10');
      label.setAttribute('font-weight', '600');
      label.style.cursor = 'pointer';
      label.textContent = (RELATION_LABELS[relation.type] || relation.type).replace(/_/g,' ');
      svg.appendChild(label);
    });
  }

  function updateRelationsSummary() {
    document.getElementById('relations-count').textContent = canvasRelations.length;
    const preview = document.getElementById('relations-preview');

    preview.innerHTML = canvasRelations.map((rel, idx) => {
      const t = (RELATION_LABELS[rel.type]||rel.type).replace(/_/g,' ');

      let descIcon, descTitle, sourceIcon = '';

      if (rel.description) {
        descIcon = '‚úèÔ∏è';
        descTitle = `Description: "${rel.description.substring(0, 50)}..."`;
      } else {
        descIcon = 'ü§ñ';
        descTitle = 'Description sera g√©n√©r√©e automatiquement par l\'IA';
      }

      if (rel.isExisting) {
        if (rel.createdBy === 'expert') {
          sourceIcon = '<span title="Cr√©√©e par expert" style="color:var(--expert-color)">üë®‚Äçüíº</span>';
        } else {
          sourceIcon = '<span title="G√©n√©r√©e par IA" style="color:var(--ai-color)">ü§ñ</span>';
        }
      } else {
        sourceIcon = '<span title="Nouvelle relation" style="color:var(--pharma-warning)">‚ú®</span>';
      }

      return `<div class="relation-preview-item" data-index="${idx}">
                <span>${rel.source.value} ‚Üí ${t} ‚Üí ${rel.target.value}</span>
                <span title="${descTitle}">${descIcon}</span>
                ${sourceIcon}
                <span class="edit" title="Modifier la description" onclick="editRelationDescription(${idx})">
                  <i class="fas fa-pen"></i>
                </span>
              </div>`;
    }).join('');
  }

  window.editRelationDescription = function(idx){
    const rel = canvasRelations[idx]; if(!rel) return;
    connectionState = {from: rel.source, to: rel.target};
    openDescriptionDialog(rel.type);
    document.getElementById('rel-desc-text').value = rel.description || '';
    // √† la validation, finalizeCreateRelation ajouterait une nouvelle relation : on remplace plut√¥t
    const okBtn = document.getElementById('rel-desc-ok');
    const aiBtn = document.getElementById('rel-desc-ai');
    const origOk = okBtn.onclick, origAi = aiBtn.onclick;
    okBtn.onclick = () => {
      const txt = (document.getElementById('rel-desc-text').value || '').trim();
      rel.description = txt || undefined;
      closeDescriptionDialog(true); clearConnectionState();
      updateRelationsSummary();
      notify('Description mise √† jour', 'success');
      okBtn.onclick = origOk; aiBtn.onclick = origAi;
    };
    aiBtn.onclick = () => {
      rel.description = undefined;
      closeDescriptionDialog(true); clearConnectionState();
      updateRelationsSummary();
      notify('Cette relation sera d√©crite par l‚ÄôIA √† la sauvegarde', 'info');
      okBtn.onclick = origOk; aiBtn.onclick = origAi;
    };
  };

  /* =================== Sauvegarde relations =================== */
  async function getAIDescriptionsForRelations(relations) {
    try {
      const r = await fetch(`/expert/document/{{ document.id }}/describe-relations-batch/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({
          relations: relations.map(rel => ({
            source_type: rel.source.type,
            source_value: rel.source.value,
            target_type: rel.target.type,
            target_value: rel.target.value,
            relation_type: rel.type
          })),
          context: 'visual_builder_batch'
        })
      });

      if (r.ok) {
        const data = await r.json();
        if (data.success && Array.isArray(data.descriptions)) {
          return data.descriptions;
        }
      }
    } catch (e) {
      console.warn('Batch description API indisponible:', e);
    }

    const descriptions = [];
    for (const rel of relations) {
      const desc = await generateSingleRelationDescription(rel);
      descriptions.push(desc || simpleAutodescribe(rel));
    }
    return descriptions;
  }

  function simpleAutodescribe(rel) {
    const verb = RELATION_LABELS[rel.type] || rel.type.replace(/_/g, ' ');
    return `${rel.source.value} ${verb} ${rel.target.value}.`;
  }

  async function postBatchRelations(relationsPayload) {
    const res = await fetch(`/expert/document/{{ document.id }}/add-relations-batch/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
      body: JSON.stringify({ relations: relationsPayload, write_to_enriched: true, origin: 'visual_builder' })
    });
    return res;
  }

  async function postOneByOne(relationsPayload) {
    let ok = 0, errors = [];
    for (const rel of relationsPayload) {
      try {
        const r = await fetch(`/expert/document/{{ document.id }}/add-relation/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
          body: JSON.stringify({
            source_type: rel.source_type, source_value: rel.source_value,
            target_type: rel.target_type, target_value: rel.target_value,
            relation_type: rel.relation_type, description: rel.description,
            write_to_enriched: true, origin: 'visual_builder'
          })
        });
        const data = await r.json();
        if (r.ok && data.success) ok++; else errors.push(data.error || 'Erreur inconnue');
      } catch (e) { errors.push(e.message); }
    }
    return { ok, errors };
  }

  window.saveAllRelations = async function saveAllRelations() {
    if (canvasRelations.length === 0) {
      notify('Aucune relation √† sauvegarder', 'warning');
      return;
    }

    const newRelations = canvasRelations.filter(rel => !rel.isExisting);

    if (newRelations.length === 0) {
      notify('Aucune nouvelle relation √† sauvegarder', 'warning');
      return;
    }

    notify(`Pr√©paration de ${newRelations.length} nouvelles relations...`, 'info');

    const needAI = newRelations.filter(r => !r.description);
    let aiDescriptions = [];

    if (needAI.length) {
      notify('G√©n√©ration des descriptions manquantes‚Ä¶', 'info');
      aiDescriptions = await getAIDescriptionsForRelations(needAI);
    }

    let aiIdx = 0;
    const relationsPayload = newRelations.map(rel => {
      const desc = rel.description || aiDescriptions[aiIdx++] || simpleAutodescribe(rel);
      return {
        source_type: rel.source.type,
        source_value: rel.source.value,
        target_type: rel.target.type,
        target_value: rel.target.value,
        relation_type: rel.type,
        description: desc
      };
    });

    try {
      notify('Sauvegarde des nouvelles relations‚Ä¶', 'info');
      const res = await fetch(`/expert/document/{{ document.id }}/add-relations-batch/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ relations: relationsPayload })
      });

      const data = await res.json();
      if (res.ok && data.success) {
        notify(`‚úÖ ${data.added_count} nouvelles relations sauvegard√©es`, 'success');
        hideModal('visual-relation-modal');
        setTimeout(() => location.reload(), 900);
      } else {
        notify('‚ùå ' + (data.error || 'Erreur lors de la sauvegarde'), 'error');
      }
    } catch (e) {
      notify('‚ùå ' + e.message, 'error');
    }
  };

  /* =================== Actions principales =================== */
  async function enrichDocumentJSON(force = false) {
    notify('Enrichissement en cours‚Ä¶', 'info');
    try {
      const url = `/expert/document/{{ document.id }}/enrich-json/` + (force ? `?force=1` : ``);
      const res = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' } });
      const data = await res.json();
      if (data.success) { notify(`‚úÖ JSON enrichi. ${data.relations_count} relations, ${data.qa_pairs_count} Q&A.`, 'success'); setTimeout(() => location.reload(), 900); }
      else { notify('‚ùå ' + (data.error || 'Erreur inconnue'), 'error'); }
    } catch (e) { notify('‚ùå ' + e.message, 'error'); }
  }
  window.enrichDocumentJSON = enrichDocumentJSON;
  window.regenerateEnrichment = () => enrichDocumentJSON(true);

  async function saveJSONChanges() {
    if (!enrichedEditor) { notify('Aucun √©diteur enrichi', 'error'); return; }
    try {
      const payload = JSON.parse(enrichedEditor.getValue());
      const res = await fetch(`/expert/document/{{ document.id }}/save-enriched-edits/`, {
        method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ manual_edits: payload })
      });
      const data = await res.json();
      if (data.success) notify('‚úÖ Modifications sauvegard√©es', 'success');
      else notify('‚ùå ' + (data.error || 'Erreur inconnue'), 'error');
    } catch (e) { notify('‚ùå JSON invalide : ' + e.message, 'error'); }
  }
  window.saveJSONChanges = saveJSONChanges;

  async function addQAPair() {
    const q = (document.getElementById('qa-question') || {}).value?.trim();
    const a = (document.getElementById('qa-answer')   || {}).value?.trim();
    const tags = (document.getElementById('qa-tags')   || {}).value?.split(',').map(s => s.trim()).filter(Boolean) || [];
    if (!q || !a) { alert('Question et r√©ponse requises'); return; }
    try {
      const res = await fetch(`/expert/document/{{ document.id }}/add-qa/`, {
        method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: q, answer: a, tags, entity_refs: [] })
      });
      const data = await res.json();
      if (data.success) { notify('‚úÖ Q&A ajout√©e', 'success'); hideModal('add-qa-modal'); setTimeout(() => location.reload(), 700); }
      else notify('‚ùå ' + data.error, 'error');
    } catch (e) { notify('‚ùå ' + e.message, 'error'); }
  }
  window.addQAPair = addQAPair;

  async function testQASystem() {
    const qEl = document.getElementById('test-question');
    const resEl = document.getElementById('qa-test-result');
    const corrBox = document.getElementById('qa-correction');
    const source = (document.querySelector('input[name="qa-source"]:checked') || {}).value || 'enriched';
    const question = (qEl && qEl.value || '').trim();
    if (!question) { alert('Veuillez saisir une question'); return; }

    resEl.style.display = 'block';
    resEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Recherche de la r√©ponse...';
    corrBox.style.display = 'none';

    try {
      const r = await fetch(`/expert/document/{{ document.id }}/test-qa/`, {
        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ question, source })
      });
      const data = await r.json();
      if (data.success) {
        const conf = data.confidence || 0;
        const color = conf > 0.8 ? '#10b981' : (conf > 0.5 ? '#f59e0b' : '#64748b');
        resEl.innerHTML =
          `<div style="display:flex;align-items:flex-start;gap:1rem;">
            <div style="flex:1;">
              <div style="font-weight:600;margin-bottom:.5rem;color:#1e293b;"><i class="fas fa-robot"></i> R√©ponse (${source}) :</div>
              <div id="qa-answer-text" style="color:#64748b;line-height:1.6;">${data.answer}</div>
            </div>
            <div style="background:${color};color:#fff;padding:.3rem .8rem;border-radius:15px;font-size:.8rem;font-weight:600;white-space:nowrap;">
              ${Math.round(conf*100)}% confiance
            </div>
          </div>
          ${data.answer_type === 'no_match' ? `<div style="margin-top:1rem;padding:1rem;background:rgba(245,158,11,.1);border-radius:8px;border-left:4px solid #f59e0b;"><strong>üí° Suggestion :</strong> ${data.suggestion || ''}</div>` : ''}
          <div style="margin-top:.75rem;text-align:right;">
            <button class="enrichment-btn secondary" onclick="openCorrection('${source}')"><i class="fas fa-edit"></i> Corriger cette r√©ponse</button>
          </div>`;
        window.__lastQA__ = { question, source, answer: data.answer };
      } else {
        resEl.innerHTML = `<div style="color:#ef4444;"><i class="fas fa-exclamation-triangle"></i> ${data.error}</div>`;
      }
    } catch (e) {
           resEl.innerHTML = `<div style="color:#ef4444;"><i class="fas fa-times-circle"></i> Erreur: ${e.message}</div>`;
    }
  }
  window.testQASystem = testQASystem;

  function openCorrection() {
    const corrBox = document.getElementById('qa-correction');
    const ta = document.getElementById('qa-corrected');
    const ans = (window.__lastQA__ || {}).answer || '';
    if (ta) ta.value = ans;
    corrBox.style.display = 'block';
  }
  window.openCorrection = openCorrection;

  async function sendQACorrection() {
    const ctx = window.__lastQA__ || {};
    const corrected = (document.getElementById('qa-corrected') || {}).value?.trim();
    if (!ctx.question || !corrected) { alert('Question ou correction manquante.'); return; }
    try {
      const r = await fetch(`/expert/document/{{ document.id }}/qa-feedback/`, {
        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ question: ctx.question, corrected_answer: corrected, source: ctx.source })
      });
      const data = await r.json();
      if (data.success) { notify('‚úÖ Correction enregistr√©e. Merci !', 'success'); document.getElementById('qa-correction').style.display = 'none'; loadLearningStats(); }
      else { notify('‚ùå ' + (data.error || 'Erreur inconnue'), 'error'); }
    } catch (e) { notify('‚ùå ' + e.message, 'error'); }
  }
  window.sendQACorrection = sendQACorrection;

  /* =================== Apprentissage =================== */
  async function loadLearningStats() {
    try {
      const response = await fetch(`/expert/document/{{ document.id }}/learning-history/`);
      const data = await response.json();
      if (data.success) {
        document.getElementById('corrections-count').textContent = data.history.total_corrections || 0;
        document.getElementById('relations-improved').textContent = data.history.history?.filter(h => h.type.includes('relation')).length || 0;
        document.getElementById('qa-improved').textContent = data.history.history?.filter(h => h.type.includes('Q&A')).length || 0;
        document.getElementById('patterns-reused').textContent = data.history.history?.reduce((sum, h) => sum + (h.reused_count || 0), 0) || 0;
      }
    } catch (e) { console.warn('Could not load learning stats:', e); }
  }

  async function compareWithFreshAI() {
    const btn = document.querySelector('button[onclick="compareWithFreshAI()"]');
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Comparaison...';
    try {
      const expertJson = enrichedEditor ? JSON.parse(enrichedEditor.getValue()) : ENRICHED;
      const response = await fetch(`/expert/document/{{ document.id }}/compare-and-learn/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ expert_json: expertJson, context: { document_title: "{{ document.title }}", doc_type: "{{ document.doc_type }}" } })
      });
      const data = await response.json();
      if (data.success) { notify(`‚úÖ ${data.message}`, 'success'); displayComparisonResults(data.comparison); loadLearningStats(); }
      else { notify(`‚ùå ${data.error}`, 'error'); }
    } catch (e) { notify('‚ùå Erreur lors de la comparaison', 'error'); }
    finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-balance-scale"></i>Comparer avec IA'; }
  }
  window.compareWithFreshAI = compareWithFreshAI;

  async function regenerateWithLearning() {
    const btn = document.querySelector('button[onclick="regenerateWithLearning()"]');
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>R√©g√©n√©ration...';
    try {
      const response = await fetch(`/expert/document/{{ document.id }}/regenerate-with-learning/`, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
      const data = await response.json();
      if (data.success) { notify(data.message, 'success'); setTimeout(() => location.reload(), 1500); }
      else { notify(data.error, 'error'); }
    } catch (e) { notify('‚ùå Erreur lors de la r√©g√©n√©ration', 'error'); }
    finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-magic"></i>R√©g√©n√©rer +Apprentissage'; }
  }
  window.regenerateWithLearning = regenerateWithLearning;

  function viewDetailedHistory() {
    window.open(`/expert/document/{{ document.id }}/view-expert-deltas/`, '_blank');
  }
  window.viewDetailedHistory = viewDetailedHistory;

  function displayComparisonResults(comparison) {
    const container = document.getElementById('comparison-cards-container');
    const resultsSection = document.getElementById('comparison-results');
    if (!comparison || !comparison.summary) return;
    let html = '';
    const summary = comparison.summary;

    if (summary.key_improvements?.length) {
      html += '<div style="margin-bottom:1rem">';
      summary.key_improvements.forEach(improvement => {
        html += `<div class="comparison-card"><div class="delta-header"><span class="delta-type-badge delta-type-relation_added">Am√©lioration d√©tect√©e</span></div><div style="padding:1rem"><div class="description-text">${improvement}</div></div></div>`;
      });
      html += '</div>';
    }
    if (summary.changes_by_type) {
      html += '<div class="learning-stats">';
      Object.entries(summary.changes_by_type).forEach(([type, count]) => {
        const label = type.replace('_',' ').replace(/\b\w/g, l => l.toUpperCase());
        html += `<div class="learning-stat"><div class="learning-stat-value">${count}</div><div class="learning-stat-label">${label}</div></div>`;
      });
      html += '</div>';
    }
    container.innerHTML = html;
    resultsSection.style.display = 'block';
  }

  /* =================== Modales =================== */
  function showModal(id){ const m = document.getElementById(id); if (m) m.classList.add('show'); }
  function hideModal(id){
    const m = document.getElementById(id); if (m) m.classList.remove('show');

    // Gestion sp√©cifique selon la modale ferm√©e
    if (id === 'visual-relation-modal') {
      clearConnectionState();
      hideRelationTypesPanel();
    }

    if (id === 'add-text-modal') {
      // Nettoyer l'√©tat du paragraphe quand on ferme la modale
      if (typeof foundParagraphRelations !== 'undefined') {
        foundParagraphRelations = [];
      }
      const previewSection = document.getElementById('paragraph-relations-preview');
      const initialActions = document.getElementById('paragraph-initial-actions');
      if (previewSection) previewSection.style.display = 'none';
      if (initialActions) initialActions.style.display = 'flex';
    }

    if (id === 'edit-relation-modal') {
      // R√©initialiser le titre de la modale d'√©dition
      const modalTitle = document.querySelector('#edit-relation-modal .modal-header-semantic h3');
      if (modalTitle) {
        modalTitle.innerHTML = '<i class="fas fa-edit"></i> Modifier la relation';
      }
      if (typeof editingRelation !== 'undefined') {
        editingRelation = null;
      }
    }
  }
  window.showModal = showModal;
  window.hideModal = hideModal;
  window.showAddQAModal = () => showModal('add-qa-modal');
  window.showAddTextModal = () => showModal('add-text-modal');

  /* =================== Analyse Documents Valid√©s Page par Page =================== */
  let validatedDocuments = [];
  let selectedDocument = null;
  let selectedPages = [];
  let pageSelectionMode = 'single';
  let analysisResults = null;
  let pdfZoomLevels = {}; // Store zoom levels for each page

  // Fonction principale pour ouvrir l'interface
  async function showDocumentPageAnalysis() {
    console.log('=== showDocumentPageAnalysis ===');
    showModal('document-page-analysis-modal');

    // Reset state
    selectedDocument = null;
    selectedPages = [];
    pageSelectionMode = 'single';
    analysisResults = null;
    pdfZoomLevels = {};

    // Show step 1
    document.getElementById('doc-selection-step').style.display = 'block';
    document.getElementById('page-selection-step').style.display = 'none';
    document.getElementById('analysis-results-step').style.display = 'none';

    await loadValidatedDocuments();
  }
  window.showDocumentPageAnalysis = showDocumentPageAnalysis;

  // Charger tous les documents valid√©s
  async function loadValidatedDocuments() {
    console.log('=== loadValidatedDocuments ===');
    const container = document.getElementById('validated-documents-list');

    try {
      container.innerHTML = `
        <div style="text-align:center;padding:3rem;color:var(--pharma-text-soft);">
          <i class="fas fa-spinner fa-spin" style="font-size:2rem;margin-bottom:1rem;"></i>
          <p>Chargement des documents valid√©s...</p>
        </div>`;

      const response = await fetch('/expert/validated-documents/');

      if (!response.ok) {
        throw new Error(`Erreur HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      console.log('Documents valid√©s re√ßus:', data);

      if (data.success) {
        validatedDocuments = data.documents || [];
        console.log(`${validatedDocuments.length} documents charg√©s`);

        if (validatedDocuments.length === 0) {
          container.innerHTML = `
            <div style="text-align:center;padding:3rem;color:var(--pharma-text-soft);">
              <i class="fas fa-inbox" style="font-size:3rem;margin-bottom:1rem;opacity:0.3;"></i>
              <p>Aucun document valid√© trouv√©</p>
            </div>`;
          notify('Aucun document valid√© disponible', 'warning');
        } else {
          displayValidatedDocuments(validatedDocuments);
          notify(`‚úÖ ${validatedDocuments.length} documents charg√©s`, 'success');
        }
      } else {
        throw new Error(data.error || 'Erreur lors du chargement des documents');
      }
    } catch (e) {
      console.error('Erreur loadValidatedDocuments:', e);
      container.innerHTML = `
        <div style="text-align:center;padding:3rem;color:#dc2626;">
          <i class="fas fa-exclamation-triangle" style="font-size:3rem;margin-bottom:1rem;"></i>
          <p><strong>Erreur de chargement</strong></p>
          <p style="font-size:0.9rem;margin-top:0.5rem;">${e.message}</p>
        </div>`;
      notify('‚ùå ' + e.message, 'error');
    }
  }

  // Afficher la liste des documents valid√©s
  function displayValidatedDocuments(documents) {
    const container = document.getElementById('validated-documents-list');

    if (documents.length === 0) {
      container.innerHTML = `
        <div style="text-align:center;padding:3rem;color:var(--pharma-text-soft);">
          <i class="fas fa-inbox" style="font-size:3rem;margin-bottom:1rem;opacity:0.3;"></i>
          <p>Aucun document valid√© trouv√©</p>
        </div>`;
      return;
    }

    container.innerHTML = documents.map(doc => `
      <div class="validated-doc-item" data-doc-id="${doc.id}" onclick="selectDocument(${doc.id})" style="
        background:#fff;
        border:2px solid ${doc.pdf_file_exists ? 'var(--pharma-border)' : '#fecaca'};
        border-radius:12px;
        padding:1.25rem;
        margin-bottom:1rem;
        cursor:pointer;
        transition:var(--pharma-transition);
        ${doc.pdf_file_exists ? '' : 'opacity:0.7;'}
      " onmouseover="this.style.borderColor='${doc.pdf_file_exists ? 'var(--pharma-primary)' : '#f87171'}'; this.style.transform='translateY(-2px)';"
         onmouseout="this.style.borderColor='${doc.pdf_file_exists ? 'var(--pharma-border)' : '#fecaca'}'; this.style.transform='translateY(0)';">
        <div style="display:flex;align-items:flex-start;gap:1rem;">
          <div style="width:40px;height:40px;background:linear-gradient(135deg,${doc.pdf_file_exists ? 'var(--pharma-primary),var(--pharma-accent)' : '#f87171,#dc2626'});border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.2rem;flex-shrink:0;">
            <i class="fas ${doc.pdf_file_exists ? 'fa-file-pdf' : 'fa-exclamation-triangle'}"></i>
          </div>
          <div style="flex:1;min-width:0;">
            <div style="font-weight:700;font-size:1rem;color:var(--pharma-text);margin-bottom:0.5rem;">
              ${doc.title || `Document #${doc.id}`}
              ${doc.pdf_file_exists ? '' : '<span style="color:#dc2626;font-size:0.85rem;font-weight:500;margin-left:0.5rem;">(PDF manquant)</span>'}
            </div>
            <div style="display:flex;gap:0.75rem;flex-wrap:wrap;margin-bottom:0.5rem;">
              ${doc.doc_type ? `<span style="background:rgba(59,130,246,0.1);color:var(--pharma-primary);padding:0.25rem 0.6rem;border-radius:6px;font-size:0.75rem;font-weight:600;"><i class="fas fa-tag"></i> ${doc.doc_type}</span>` : ''}
              ${doc.source ? `<span style="background:rgba(16,185,129,0.1);color:var(--pharma-accent);padding:0.25rem 0.6rem;border-radius:6px;font-size:0.75rem;font-weight:600;"><i class="fas fa-building"></i> ${doc.source}</span>` : ''}
              ${doc.country ? `<span style="background:rgba(245,158,11,0.1);color:var(--pharma-warning);padding:0.25rem 0.6rem;border-radius:6px;font-size:0.75rem;font-weight:600;"><i class="fas fa-globe"></i> ${doc.country}</span>` : ''}
              ${doc.pdf_file_exists ? '<span style="background:rgba(16,185,129,0.1);color:var(--pharma-success);padding:0.25rem 0.6rem;border-radius:6px;font-size:0.75rem;font-weight:600;"><i class="fas fa-check"></i> PDF disponible</span>' : '<span style="background:rgba(239,68,68,0.1);color:#dc2626;padding:0.25rem 0.6rem;border-radius:6px;font-size:0.75rem;font-weight:600;"><i class="fas fa-times"></i> PDF indisponible</span>'}
            </div>
            <div style="display:flex;gap:1.5rem;font-size:0.8rem;color:var(--pharma-text-soft);">
              <span><i class="fas fa-file-alt"></i> ${doc.total_pages} pages</span>
              <span><i class="fas fa-check-circle" style="color:var(--pharma-success);"></i> ${doc.pages_analyzed} analys√©es</span>
              ${doc.has_enriched_json ? '<span><i class="fas fa-brain" style="color:var(--pharma-primary);"></i> JSON enrichi</span>' : ''}
            </div>
          </div>
          <div style="text-align:right;flex-shrink:0;">
            <i class="fas fa-chevron-right" style="color:var(--pharma-text-soft);font-size:1.2rem;"></i>
          </div>
        </div>
      </div>
    `).join('');
  }

  // Filtrer les documents
  function filterValidatedDocuments(query) {
    const filtered = validatedDocuments.filter(doc => {
      const searchText = `${doc.title} ${doc.doc_type} ${doc.source} ${doc.country}`.toLowerCase();
      return searchText.includes(query.toLowerCase());
    });
    displayValidatedDocuments(filtered);
  }
  window.filterValidatedDocuments = filterValidatedDocuments;

  // S√©lectionner un document
  async function selectDocument(docId) {
    console.log(`=== selectDocument: ${docId} ===`);

    try {
      selectedDocument = validatedDocuments.find(d => d.id === docId);

      if (!selectedDocument) {
        console.error(`‚ùå Document ID ${docId} non trouv√©`);
        notify('‚ùå Document introuvable', 'error');
        return;
      }

      console.log('‚úÖ Document s√©lectionn√©:', selectedDocument);

      // Reset page selection
      selectedPages = [];
      pageSelectionMode = 'single';

      // Passer √† l'√©tape 2
      document.getElementById('doc-selection-step').style.display = 'none';
      document.getElementById('page-selection-step').style.display = 'block';
      document.getElementById('analysis-results-step').style.display = 'none';

      // Afficher les infos du document
      const titleEl = document.getElementById('selected-doc-title');
      const metaEl = document.getElementById('selected-doc-meta');

      if (titleEl) {
        titleEl.textContent = selectedDocument.title || `Document #${selectedDocument.id}`;
      }

      if (metaEl) {
        metaEl.innerHTML = `
          ${selectedDocument.doc_type ? `<span style="margin-right:1rem;"><i class="fas fa-tag"></i> ${selectedDocument.doc_type}</span>` : ''}
          ${selectedDocument.source ? `<span style="margin-right:1rem;"><i class="fas fa-building"></i> ${selectedDocument.source}</span>` : ''}
          <span><i class="fas fa-file-alt"></i> ${selectedDocument.total_pages || 0} page(s)</span>
        `;
      }

      // Charger les pages du document
      await loadDocumentPages(docId);

    } catch (e) {
      console.error('Erreur selectDocument:', e);
      notify('‚ùå Erreur lors de la s√©lection du document', 'error');
    }
  }
  window.selectDocument = selectDocument;

  // Charger les pages du document
  async function loadDocumentPages(docId) {
    console.log(`=== loadDocumentPages: ${docId} ===`);
    const container = document.getElementById('document-pages-list');

    try {
      container.innerHTML = `
        <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft);">
          <i class="fas fa-spinner fa-spin" style="font-size:1.5rem;margin-bottom:1rem;"></i>
          <p>Chargement des pages...</p>
        </div>`;

      const response = await fetch(`/expert/document/${docId}/get-page-relations/`);

      if (!response.ok) {
        throw new Error(`Erreur HTTP ${response.status}`);
      }

      const data = await response.json();
      console.log('Pages re√ßues:', data);

      if (data.success) {
        const analyzedPages = data.pages || [];
        const totalPages = data.document?.total_pages || selectedDocument?.total_pages || 0;

        console.log(`Total pages: ${totalPages}, Pages analys√©es: ${analyzedPages.length}`);

        if (totalPages === 0) {
          container.innerHTML = `
            <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft);">
              <i class="fas fa-info-circle" style="font-size:1.5rem;"></i>
              <p>Aucune page disponible pour ce document</p>
            </div>`;
          return;
        }

        displayDocumentPages(analyzedPages, totalPages);
      } else {
        throw new Error(data.error || 'Erreur lors du chargement des pages');
      }
    } catch (e) {
      console.error('Erreur loadDocumentPages:', e);
      container.innerHTML = `
        <div style="text-align:center;padding:2rem;color:#dc2626;">
          <i class="fas fa-exclamation-triangle" style="font-size:1.5rem;margin-bottom:1rem;"></i>
          <p><strong>Erreur</strong></p>
          <p style="font-size:0.9rem;">${e.message}</p>
        </div>`;
      notify('‚ùå ' + e.message, 'error');
    }
  }

  // Afficher les pages du document
  function displayDocumentPages(analyzedPages, totalPages) {
    const container = document.getElementById('document-pages-list');
    const pagesHtml = [];

    for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
      const pageData = analyzedPages.find(p => p.page_number === pageNum);
      const isAnalyzed = !!pageData;
      const relationsCount = pageData?.relations?.length || 0;
      const entitiesCount = pageData?.entities ? Object.values(pageData.entities).flat().length : 0;

      pagesHtml.push(`
        <div class="page-selection-item" data-page="${pageNum}" onclick="togglePageSelection(${pageNum})" style="
          background:${isAnalyzed ? 'linear-gradient(135deg,rgba(16,185,129,0.05),rgba(59,130,246,0.05))' : '#fff'};
          border:2px solid ${isAnalyzed ? 'rgba(16,185,129,0.3)' : 'var(--pharma-border)'};
          border-radius:10px;
          padding:1rem;
          margin-bottom:0.75rem;
          cursor:pointer;
          transition:var(--pharma-transition);
          display:flex;
          align-items:center;
          gap:1rem;
        " onmouseover="this.style.transform='translateX(4px)';" onmouseout="this.style.transform='translateX(0)';">
          <input type="checkbox" class="page-checkbox" data-page="${pageNum}" style="width:18px;height:18px;cursor:pointer;" onclick="event.stopPropagation();">
          <div style="width:36px;height:36px;background:${isAnalyzed ? 'linear-gradient(135deg,var(--pharma-success),var(--pharma-accent))' : 'linear-gradient(135deg,var(--pharma-primary),#6366f1)'};border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.9rem;flex-shrink:0;">
            ${pageNum}
          </div>
          <div style="flex:1;">
            <div style="font-weight:600;font-size:0.9rem;color:var(--pharma-text);margin-bottom:0.25rem;">
              Page ${pageNum}
              ${isAnalyzed ? '<span style="color:var(--pharma-success);margin-left:0.5rem;"><i class="fas fa-check-circle"></i> Analys√©e</span>' : '<span style="color:var(--pharma-text-soft);margin-left:0.5rem;">Non analys√©e</span>'}
            </div>
            ${pageData?.summary ? `<div style="font-size:0.8rem;color:var(--pharma-text-soft);margin-bottom:0.25rem;">${pageData.summary.substring(0, 80)}...</div>` : ''}
            ${isAnalyzed ? `
              <div style="display:flex;gap:1rem;font-size:0.75rem;color:var(--pharma-text-soft);">
                ${relationsCount > 0 ? `<span><i class="fas fa-project-diagram"></i> ${relationsCount} relation(s)</span>` : ''}
                ${entitiesCount > 0 ? `<span><i class="fas fa-cubes"></i> ${entitiesCount} entit√©(s)</span>` : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `);
    }

    container.innerHTML = pagesHtml.join('');
  }

  // Mode de s√©lection des pages
  function updatePageSelectionMode(mode) {
    console.log(`=== updatePageSelectionMode: ${mode} ===`);

    if (!selectedDocument) {
      console.error('‚ùå Aucun document s√©lectionn√©');
      return;
    }

    pageSelectionMode = mode;
    selectedPages = [];

    // D√©cocher toutes les cases
    document.querySelectorAll('.page-checkbox').forEach(cb => {
      cb.checked = false;
    });

    if (mode === 'all') {
      // S√©lectionner toutes les pages
      const totalPages = selectedDocument.total_pages || 0;
      selectedPages = Array.from({length: totalPages}, (_, i) => i + 1);

      document.querySelectorAll('.page-checkbox').forEach(cb => {
        cb.checked = true;
      });

      console.log(`‚úÖ Toutes les pages s√©lectionn√©es (${totalPages} pages)`);
    } else {
      console.log(`‚úÖ Mode ${mode} activ√© - s√©lection manuelle`);
    }

    // Update button state
    updateAnalyzeButtonState();
  }
  window.updatePageSelectionMode = updatePageSelectionMode;

  // Update analyze button state
  function updateAnalyzeButtonState() {
    const btn = document.getElementById('analyze-pages-btn');
    if (!btn) return;

    const hasSelection = selectedPages.length > 0;
    btn.disabled = !hasSelection;

    if (hasSelection) {
      btn.innerHTML = `<i class="fas fa-magic"></i> Analyser ${selectedPages.length} page(s)`;
    } else {
      btn.innerHTML = '<i class="fas fa-magic"></i> Analyser les relations';
    }
  }

  // Toggle s√©lection d'une page
  function togglePageSelection(pageNum) {
    console.log(`=== togglePageSelection: Page ${pageNum} ===`);

    if (pageSelectionMode === 'all') {
      console.log('Mode "all" - toggle d√©sactiv√©');
      return;
    }

    const checkbox = document.querySelector(`.page-checkbox[data-page="${pageNum}"]`);
    if (!checkbox) {
      console.error(`‚ùå Checkbox non trouv√©e pour page ${pageNum}`);
      return;
    }

    checkbox.checked = !checkbox.checked;

    if (checkbox.checked) {
      if (pageSelectionMode === 'single') {
        // Mode single: d√©cocher les autres
        selectedPages = [pageNum];
        document.querySelectorAll('.page-checkbox').forEach(cb => {
          const cbPage = parseInt(cb.dataset.page);
          if (cbPage !== pageNum) {
            cb.checked = false;
          }
        });
        console.log(`‚úÖ Mode single - Page ${pageNum} s√©lectionn√©e`);
      } else {
        // Mode multiple: ajouter
        if (!selectedPages.includes(pageNum)) {
          selectedPages.push(pageNum);
          selectedPages.sort((a, b) => a - b); // Trier les pages
        }
        console.log(`‚úÖ Mode multiple - Page ${pageNum} ajout√©e. Total: ${selectedPages.length}`);
      }
    } else {
      // Retirer la page
      selectedPages = selectedPages.filter(p => p !== pageNum);
      console.log(`‚úÖ Page ${pageNum} retir√©e. Reste: ${selectedPages.length}`);
    }

    console.log('Pages s√©lectionn√©es:', selectedPages);

    // Update button state
    updateAnalyzeButtonState();
  }
  window.togglePageSelection = togglePageSelection;

  // Analyser les pages s√©lectionn√©es
  async function analyzeSelectedPages() {
    console.log('=== analyzeSelectedPages ===');
    console.log('Document s√©lectionn√©:', selectedDocument);
    console.log('Mode de s√©lection:', pageSelectionMode);
    console.log('Pages s√©lectionn√©es:', selectedPages);

    // Validations
    if (!selectedDocument) {
      console.error('‚ùå Aucun document s√©lectionn√©');
      notify('‚ùå Erreur: Aucun document s√©lectionn√©', 'error');
      return;
    }

    if (!selectedDocument.id) {
      console.error('‚ùå ID du document manquant');
      notify('‚ùå Erreur: Document invalide', 'error');
      return;
    }

    // D√©terminer les pages √† analyser
    let pagesToAnalyze = [];

    if (pageSelectionMode === 'all') {
      const totalPages = selectedDocument.total_pages || 0;
      pagesToAnalyze = Array.from({length: totalPages}, (_, i) => i + 1);
      console.log(`Mode "all" - ${totalPages} pages`);
    } else {
      pagesToAnalyze = [...selectedPages];
      console.log(`Mode "${pageSelectionMode}" - ${pagesToAnalyze.length} pages`);
    }

    if (pagesToAnalyze.length === 0) {
      notify('‚ö†Ô∏è Veuillez s√©lectionner au moins une page', 'warning');
      return;
    }

    console.log('Pages √† analyser:', pagesToAnalyze);

    const btn = document.getElementById('analyze-pages-btn');
    const originalBtnHtml = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyse en cours...';

    try {
      const apiUrl = `/expert/document/${selectedDocument.id}/analyze-pages-relations/`;
      console.log('API URL:', apiUrl);

      notify(`üîÑ Analyse de ${pagesToAnalyze.length} page(s) en cours...`, 'info');

      const requestBody = {
        page_numbers: pagesToAnalyze,
        force_reanalyze: false
      };
      console.log('Request body:', requestBody);

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(requestBody)
      });

      console.log('Response status:', response.status);
      console.log('Response OK:', response.ok);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Response error text:', errorText);
        throw new Error(`Erreur HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      console.log('‚úÖ Response data:', data);

      if (data.success) {
        analysisResults = data;

        console.log(`‚úÖ Analyse r√©ussie:`);
        console.log(`- Pages analys√©es: ${data.pages_analyzed}`);
        console.log(`- Relations trouv√©es: ${data.total_relations}`);
        console.log(`- Donn√©es des pages:`, data.pages_data);

        // Afficher les r√©sultats
        displayAnalysisResults(data);

        // Passer √† l'√©tape 3
        document.getElementById('page-selection-step').style.display = 'none';
        document.getElementById('analysis-results-step').style.display = 'block';
        document.getElementById('doc-selection-step').style.display = 'none';

        notify(`‚úÖ ${data.message || 'Analyse termin√©e avec succ√®s'}`, 'success');
      } else {
        throw new Error(data.error || 'Erreur inconnue lors de l\'analyse');
      }

    } catch (e) {
      console.error('‚ùå Erreur analyzeSelectedPages:', e);
      console.error('Stack trace:', e.stack);
      notify(`‚ùå Erreur: ${e.message}`, 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalBtnHtml;
    }
  }
  window.analyzeSelectedPages = analyzeSelectedPages;

  // Afficher les r√©sultats de l'analyse
  function displayAnalysisResults(data) {
    console.log('=== displayAnalysisResults ===');
    console.log('Data re√ßue:', data);

    if (!data || !data.pages_data) {
      console.error('‚ùå Donn√©es invalides pour displayAnalysisResults');
      notify('‚ùå Erreur: Donn√©es d\'analyse invalides', 'error');
      return;
    }

    const statsContainer = document.getElementById('analysis-stats');
    if (!statsContainer) {
      console.error('‚ùå Container analysis-stats non trouv√©');
      return;
    }

    // Afficher les statistiques
    const pagesAnalyzed = data.pages_analyzed || 0;
    const totalRelations = data.total_relations || 0;

    console.log(`Statistiques: ${pagesAnalyzed} pages, ${totalRelations} relations`);

    statsContainer.innerHTML = `
      <div style="background:#fff;border:2px solid var(--pharma-border);border-radius:12px;padding:1.25rem;text-align:center;">
        <div style="font-size:2rem;font-weight:800;color:var(--pharma-primary);margin-bottom:0.25rem;">${pagesAnalyzed}</div>
        <div style="font-size:0.85rem;color:var(--pharma-text-soft);">Pages analys√©es</div>
      </div>
      <div style="background:#fff;border:2px solid var(--pharma-border);border-radius:12px;padding:1.25rem;text-align:center;">
        <div style="font-size:2rem;font-weight:800;color:var(--pharma-success);margin-bottom:0.25rem;">${totalRelations}</div>
        <div style="font-size:0.85rem;color:var(--pharma-text-soft);">Relations trouv√©es</div>
      </div>
    `;

    // Afficher les relations par page
    const relationsContainer = document.getElementById('page-relations-container');
    if (!relationsContainer) {
      console.error('‚ùå Container page-relations-container non trouv√©');
      return;
    }

    console.log(`G√©n√©ration HTML pour ${data.pages_data.length} pages...`);

    const pagesHtml = data.pages_data.map((page, pageIndex) => {
      console.log(`Page ${page.page_number}:`, page);

      const relations = page.relations || [];
      const entities = page.entities || {};
      const pageNumber = page.page_number;

      return `
        <div style="background:#fff;border:2px solid var(--pharma-border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem;">
          <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;padding-bottom:1rem;border-bottom:2px solid var(--pharma-border);">
            <div style="width:40px;height:40px;background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;">
              ${page.page_number}
            </div>
            <div style="flex:1;">
              <div style="font-weight:700;font-size:1.05rem;color:var(--pharma-text);">Page ${page.page_number}</div>
              ${page.summary ? `<div style="font-size:0.85rem;color:var(--pharma-text-soft);margin-top:0.25rem;">${page.summary}</div>` : ''}
            </div>
            <div style="display:flex;gap:0.75rem;align-items:center;">
              <span style="background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(16,185,129,0.1));color:var(--pharma-primary);padding:0.4rem 0.8rem;border-radius:8px;font-size:0.85rem;font-weight:600;">
                <i class="fas fa-project-diagram"></i> ${relations.length} relation(s)
              </span>
              <button onclick="addRelationToPage(${page.page_number})"
                      style="background:var(--pharma-success);color:#fff;border:none;padding:0.4rem 0.8rem;border-radius:8px;cursor:pointer;font-size:0.85rem;font-weight:600;display:flex;align-items:center;gap:0.3rem;transition:var(--pharma-transition);"
                      onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
                      onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none';">
                <i class="fas fa-plus-circle"></i> Ajouter
              </button>
            </div>
          </div>

          <!-- Layout c√¥te √† c√¥te: PDF Viewer + Relations -->
          <div id="pdf-relations-grid-${page.page_number}" style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-top:1rem;">
            <!-- Panel PDF Viewer -->
            <div id="pdf-panel-${page.page_number}" style="background:#f8fafc;border:2px solid var(--pharma-border);border-radius:12px;padding:1rem;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:2px solid var(--pharma-border);">
                <h4 style="margin:0;font-size:0.95rem;font-weight:600;color:var(--pharma-text);display:flex;align-items:center;gap:0.5rem;">
                  <i class="fas fa-file-pdf"></i> Page ${page.page_number} du Document
                </h4>
                <div style="display:flex;gap:0.5rem;">
                  <button onclick="zoomPdfPage(${page.page_number}, 'in')"
                          style="width:32px;height:32px;border-radius:6px;border:1px solid var(--pharma-border);background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--pharma-transition);"
                          onmouseover="this.style.background='var(--pharma-primary)';this.style.color='white';"
                          onmouseout="this.style.background='#fff';this.style.color='var(--pharma-text)';"
                          title="Zoom avant">
                    <i class="fas fa-search-plus"></i>
                  </button>
                  <button onclick="zoomPdfPage(${page.page_number}, 'out')"
                          style="width:32px;height:32px;border-radius:6px;border:1px solid var(--pharma-border);background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--pharma-transition);"
                          onmouseover="this.style.background='var(--pharma-primary)';this.style.color='white';"
                          onmouseout="this.style.background='#fff';this.style.color='var(--pharma-text)';"
                          title="Zoom arri√®re">
                    <i class="fas fa-search-minus"></i>
                  </button>
                  <button onclick="zoomPdfPage(${page.page_number}, 'reset')"
                          style="width:32px;height:32px;border-radius:6px;border:1px solid var(--pharma-border);background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--pharma-transition);"
                          onmouseover="this.style.background='var(--pharma-primary)';this.style.color='white';"
                          onmouseout="this.style.background='#fff';this.style.color='var(--pharma-text)';"
                          title="R√©initialiser">
                    <i class="fas fa-undo"></i>
                  </button>
                </div>
              </div>
              <div id="pdf-container-${page.page_number}"
                   style="width:100%;overflow:auto;max-height:600px;background:#fff;border-radius:8px;display:flex;justify-content:center;align-items:center;padding:1rem;min-height:400px;">
                <i class="fas fa-spinner fa-spin" style="font-size:2rem;color:var(--pharma-primary);"></i>
              </div>
            </div>

            <!-- Panel Relations -->
            <div id="relations-panel-${page.page_number}" style="overflow-y:auto;max-height:600px;">
              ${relations.length > 0 ? `
                <div style="display:flex;flex-direction:column;gap:0.75rem;">
                  ${relations.map((rel, relIdx) => `
                    <div class="relation-card-${page.page_number}-${relIdx}" style="background:linear-gradient(135deg,rgba(59,130,246,0.05),rgba(16,185,129,0.05));border:1px solid rgba(59,130,246,0.2);border-radius:8px;padding:1rem;position:relative;">
                  <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
                    <div style="background:var(--pharma-primary);color:#fff;padding:0.4rem 0.9rem;border-radius:15px;font-size:0.85rem;font-weight:600;">
                      ${rel.source?.value || 'N/A'}
                    </div>
                    <div style="background:var(--pharma-accent);color:#fff;padding:0.3rem 0.7rem;border-radius:12px;font-size:0.75rem;font-weight:600;">
                      ${rel.type || 'relation'}
                    </div>
                    <i class="fas fa-arrow-right" style="color:var(--pharma-accent);font-size:1.1rem;"></i>
                    <div style="background:var(--pharma-primary);color:#fff;padding:0.4rem 0.9rem;border-radius:15px;font-size:0.85rem;font-weight:600;">
                      ${rel.target?.value || 'N/A'}
                    </div>
                    ${rel.description ? `<div style="flex:1 1 100%;font-style:italic;color:var(--pharma-text-soft);font-size:0.85rem;margin-top:0.25rem;">${rel.description}</div>` : ''}
                  </div>
                  <div style="position:absolute;top:0.75rem;right:0.75rem;display:flex;gap:0.5rem;">
                    <button onclick="editRelation(${page.page_number}, ${relIdx}, ${JSON.stringify(rel).replace(/"/g, '&quot;')})"
                            style="background:#fff;border:1px solid var(--pharma-primary);color:var(--pharma-primary);padding:0.3rem 0.6rem;border-radius:6px;cursor:pointer;font-size:0.75rem;display:flex;align-items:center;gap:0.3rem;transition:var(--pharma-transition);"
                            onmouseover="this.style.background='var(--pharma-primary)';this.style.color='#fff';"
                            onmouseout="this.style.background='#fff';this.style.color='var(--pharma-primary)';">
                      <i class="fas fa-edit"></i> Modifier
                    </button>
                    <button onclick="deleteRelation(${page.page_number}, ${relIdx})"
                            style="background:#fff;border:1px solid #dc2626;color:#dc2626;padding:0.3rem 0.6rem;border-radius:6px;cursor:pointer;font-size:0.75rem;display:flex;align-items:center;gap:0.3rem;transition:var(--pharma-transition);"
                            onmouseover="this.style.background='#dc2626';this.style.color='#fff';"
                            onmouseout="this.style.background='#fff';this.style.color='#dc2626';">
                      <i class="fas fa-trash"></i> Supprimer
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : `
            <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft);">
              <i class="fas fa-info-circle" style="font-size:1.5rem;margin-bottom:0.5rem;opacity:0.5;"></i>
              <p>Aucune relation trouv√©e sur cette page</p>
            </div>
          `}
            </div>
          </div>
        </div>
      `;
    }).join('');

    relationsContainer.innerHTML = pagesHtml;

    console.log(`‚úÖ HTML g√©n√©r√© pour ${data.pages_data.length} pages`);
    console.log('Document actuel pour chargement PDF:', selectedDocument);

    // Charger les images PDF pour chaque page avec un d√©lai pour √©viter la surcharge
    data.pages_data.forEach((page, index) => {
      setTimeout(() => {
        console.log(`üîÑ Chargement PDF pour page ${page.page_number}...`);
        loadPdfPageImage(page.page_number);
      }, index * 200); // D√©lai de 200ms entre chaque chargement
    });

    console.log('‚úÖ displayAnalysisResults termin√©');
  }

  // ============================================
  // PDF VIEWER FUNCTIONS
  // ============================================

  // Load PDF page image
  async function loadPdfPageImage(pageNum) {
    console.log(`=== loadPdfPageImage: Page ${pageNum} ===`);

    const container = document.getElementById(`pdf-container-${pageNum}`);
    if (!container) {
      console.error(`‚ùå Container pdf-container-${pageNum} introuvable`);
      return;
    }

    // V√©rifications de s√©curit√©
    if (!selectedDocument) {
      console.error('‚ùå selectedDocument est null');
      showPdfError(pageNum, 'Document non s√©lectionn√©');
      return;
    }

    if (!selectedDocument.id) {
      console.error('‚ùå selectedDocument.id manquant:', selectedDocument);
      showPdfError(pageNum, 'ID du document manquant');
      return;
    }

    // V√©rifier si le PDF existe
    if (selectedDocument.pdf_file_exists === false) {
      console.warn(`‚ö†Ô∏è PDF non disponible pour document ${selectedDocument.id}`);
      showPdfError(pageNum, 'PDF non disponible pour ce document');
      return;
    }

    try {
      // Initialize zoom level
      if (!pdfZoomLevels[pageNum]) {
        pdfZoomLevels[pageNum] = 1.0;
      }

      const imageUrl = `/expert/page-image/${selectedDocument.id}/${pageNum}/`;
      console.log(`üìÑ Chargement depuis: ${imageUrl}`);

      // Afficher un loader
      container.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;padding:2rem;">
          <i class="fas fa-spinner fa-spin" style="font-size:2rem;color:var(--pharma-primary);"></i>
          <p style="font-size:0.9rem;color:var(--pharma-text-soft);">Chargement de la page ${pageNum}...</p>
        </div>`;

      // Create image element
      const img = document.createElement('img');
      img.id = `pdf-image-${pageNum}`;
      img.src = imageUrl;
      img.alt = `Page ${pageNum}`;
      img.style.cssText = `
        max-width: 100%;
        height: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        transition: transform 0.3s ease;
        transform: scale(${pdfZoomLevels[pageNum]});
        transform-origin: top center;
      `;

      img.onload = () => {
        console.log(`‚úÖ PDF charg√© avec succ√®s pour page ${pageNum}`);
        container.innerHTML = '';
        container.appendChild(img);
      };

      img.onerror = (e) => {
        console.warn(`‚ö†Ô∏è √âchec du chargement PDF pour page ${pageNum}`);
        console.warn('URL:', imageUrl);
        console.warn('Event:', e);
        showPdfError(pageNum, 'Fichier PDF introuvable ou inaccessible');
      };

    } catch (error) {
      console.error(`‚ùå Exception loadPdfPageImage page ${pageNum}:`, error);
      showPdfError(pageNum, error.message);
    }
  }
  window.loadPdfPageImage = loadPdfPageImage;

  // Show PDF error and hide panel
  function showPdfError(pageNum, errorMessage) {
    console.log(`showPdfError pour page ${pageNum}: ${errorMessage}`);

    const pdfPanel = document.getElementById(`pdf-panel-${pageNum}`);
    const gridContainer = document.getElementById(`pdf-relations-grid-${pageNum}`);
    const container = document.getElementById(`pdf-container-${pageNum}`);

    // Masquer le panel PDF
    if (pdfPanel) {
      pdfPanel.style.display = 'none';
      console.log(`‚úÖ Panel PDF masqu√© pour page ${pageNum}`);
    }

    // Adapter la grille en mode 1 colonne (relations uniquement)
    if (gridContainer) {
      gridContainer.style.gridTemplateColumns = '1fr';
      console.log(`‚úÖ Grille adapt√©e en 1 colonne pour page ${pageNum}`);
    }

    // Afficher message d'erreur si container existe encore
    if (container && container.style.display !== 'none') {
      container.innerHTML = `
        <div style="text-align:center;padding:1.5rem;color:#dc2626;background:#fef2f2;border-radius:8px;">
          <i class="fas fa-file-excel" style="font-size:2rem;margin-bottom:0.5rem;"></i>
          <p style="font-size:0.85rem;font-weight:600;margin:0;">${errorMessage}</p>
        </div>`;
    }
  }

  // Zoom PDF page
  function zoomPdfPage(pageNum, action) {
    const img = document.getElementById(`pdf-image-${pageNum}`);
    if (!img) return;

    // Initialize zoom level if needed
    if (!pdfZoomLevels[pageNum]) {
      pdfZoomLevels[pageNum] = 1.0;
    }

    switch(action) {
      case 'in':
        pdfZoomLevels[pageNum] = Math.min(pdfZoomLevels[pageNum] + 0.25, 3.0);
        break;
      case 'out':
        pdfZoomLevels[pageNum] = Math.max(pdfZoomLevels[pageNum] - 0.25, 0.5);
        break;
      case 'reset':
        pdfZoomLevels[pageNum] = 1.0;
        break;
    }

    img.style.transform = `scale(${pdfZoomLevels[pageNum]})`;
  }
  window.zoomPdfPage = zoomPdfPage;

  // ============================================

  // Navigation entre les √©tapes
  function backToDocumentSelection() {
    console.log('=== backToDocumentSelection ===');

    // Reset state
    selectedDocument = null;
    selectedPages = [];
    pageSelectionMode = 'single';
    analysisResults = null;

    // Show/hide steps
    document.getElementById('page-selection-step').style.display = 'none';
    document.getElementById('analysis-results-step').style.display = 'none';
    document.getElementById('doc-selection-step').style.display = 'block';

    console.log('‚úÖ Retour √† la s√©lection de document');
  }
  window.backToDocumentSelection = backToDocumentSelection;

  function backToPageSelection() {
    console.log('=== backToPageSelection ===');

    // Show/hide steps
    document.getElementById('analysis-results-step').style.display = 'none';
    document.getElementById('doc-selection-step').style.display = 'none';
    document.getElementById('page-selection-step').style.display = 'block';

    console.log('‚úÖ Retour √† la s√©lection de pages');
  }
  window.backToPageSelection = backToPageSelection;

  // Exporter les r√©sultats
  function exportAnalysisResults() {
    console.log('=== exportAnalysisResults ===');

    if (!analysisResults) {
      console.error('‚ùå Aucun r√©sultat √† exporter');
      notify('‚ùå Aucun r√©sultat disponible', 'warning');
      return;
    }

    if (!selectedDocument || !selectedDocument.id) {
      console.error('‚ùå Document non s√©lectionn√©');
      notify('‚ùå Document invalide', 'error');
      return;
    }

    try {
      const dataStr = JSON.stringify(analysisResults, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const timestamp = new Date().toISOString().split('T')[0];
      const filename = `analysis_doc_${selectedDocument.id}_${timestamp}.json`;

      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);

      console.log(`‚úÖ Fichier export√©: ${filename}`);
      notify('‚úÖ R√©sultats export√©s avec succ√®s', 'success');

    } catch (e) {
      console.error('‚ùå Erreur exportAnalysisResults:', e);
      notify('‚ùå Erreur lors de l\'exportation', 'error');
    }
  }
  window.exportAnalysisResults = exportAnalysisResults;

  // Ajouter les relations au document actuel
  async function addAnalysisToDocument() {
    if (!analysisResults) return;

    if (!confirm('Ajouter toutes les relations trouv√©es au JSON enrichi du document ?')) return;

    try {
      // Les relations sont d√©j√† sauvegard√©es dans le document analys√©
      // On peut juste rafra√Æchir la page
      notify('‚úÖ Relations ajout√©es au document', 'success');
      setTimeout(() => location.reload(), 1000);
    } catch (e) {
      notify('‚ùå ' + e.message, 'error');
    }
  }
  window.addAnalysisToDocument = addAnalysisToDocument;

  // √âditer une relation
  let editingRelation = null;
  function editRelation(pageNumber, relationIndex, relationData) {
    editingRelation = { pageNumber, relationIndex, data: relationData };

    // Remplir la modale d'√©dition
    document.getElementById('edit-source-value').value = relationData.source?.value || '';
    document.getElementById('edit-source-type').value = relationData.source?.type || 'product';
    document.getElementById('edit-relation-type').value = relationData.type || '';
    document.getElementById('edit-target-value').value = relationData.target?.value || '';
    document.getElementById('edit-target-type').value = relationData.target?.type || 'product';
    document.getElementById('edit-relation-description').value = relationData.description || '';

    showModal('edit-relation-modal');
  }
  window.editRelation = editRelation;

  // Sauvegarder la relation modifi√©e ou nouvelle
  async function saveEditedRelation() {
    if (!editingRelation || !analysisResults) return;

    // Validation des champs
    const sourceValue = document.getElementById('edit-source-value').value.trim();
    const targetValue = document.getElementById('edit-target-value').value.trim();
    const relationType = document.getElementById('edit-relation-type').value.trim();

    if (!sourceValue || !targetValue || !relationType) {
      alert('Veuillez remplir tous les champs obligatoires (Source, Cible et Type de relation)');
      return;
    }

    const updatedRelation = {
      source: {
        type: document.getElementById('edit-source-type').value,
        value: sourceValue
      },
      target: {
        type: document.getElementById('edit-target-type').value,
        value: targetValue
      },
      type: relationType,
      description: document.getElementById('edit-relation-description').value.trim() || undefined
    };

    // Mettre √† jour dans les r√©sultats locaux
    const pageData = analysisResults.pages_data.find(p => p.page_number === editingRelation.pageNumber);
    if (pageData) {
      if (!pageData.relations) {
        pageData.relations = [];
      }

      if (editingRelation.relationIndex === -1) {
        // Nouvelle relation
        pageData.relations.push(updatedRelation);
        analysisResults.total_relations++;
        notify('‚úÖ Nouvelle relation ajout√©e', 'success');
      } else {
        // Modification d'une relation existante
        pageData.relations[editingRelation.relationIndex] = updatedRelation;
        notify('‚úÖ Relation mise √† jour', 'success');
      }
    }

    // Rafra√Æchir l'affichage
    displayAnalysisResults(analysisResults);
    hideModal('edit-relation-modal');

    editingRelation = null;
  }
  window.saveEditedRelation = saveEditedRelation;

  // Supprimer une relation
  function deleteRelation(pageNumber, relationIndex) {
    if (!confirm('Voulez-vous vraiment supprimer cette relation ?')) return;

    if (!analysisResults) return;

    // Supprimer de la liste locale
    const pageData = analysisResults.pages_data.find(p => p.page_number === pageNumber);
    if (pageData && pageData.relations) {
      pageData.relations.splice(relationIndex, 1);
      analysisResults.total_relations--;
    }

    // Rafra√Æchir l'affichage
    displayAnalysisResults(analysisResults);
    notify('‚úÖ Relation supprim√©e', 'success');
  }
  window.deleteRelation = deleteRelation;

  // Ajouter une nouvelle relation √† une page
  function addRelationToPage(pageNumber) {
    const pageData = analysisResults.pages_data.find(p => p.page_number === pageNumber);
    if (!pageData) return;

    editingRelation = {
      pageNumber,
      relationIndex: -1,  // -1 signifie nouvelle relation
      data: {
        source: { type: 'product', value: '' },
        target: { type: 'product', value: '' },
        type: '',
        description: ''
      }
    };

    // Remplir la modale pour une nouvelle relation
    document.getElementById('edit-source-value').value = '';
    document.getElementById('edit-source-type').value = 'product';
    document.getElementById('edit-relation-type').value = '';
    document.getElementById('edit-target-value').value = '';
    document.getElementById('edit-target-type').value = 'product';
    document.getElementById('edit-relation-description').value = '';

    // Changer le titre de la modale
    document.querySelector('#edit-relation-modal .modal-header-semantic h3').innerHTML =
      '<i class="fas fa-plus-circle"></i> Ajouter une nouvelle relation';

    showModal('edit-relation-modal');
  }
  window.addRelationToPage = addRelationToPage;

  document.addEventListener('click', e => {
    if (e.target.classList?.contains('semantic-modal')) e.target.classList.remove('show');
  });

  /* =================== Paragraphe =================== */
  // Dans la section /* =================== Paragraphe =================== */
// Remplacer tout le code de cette section par :

/* =================== Paragraphe =================== */

// Variables globales pour les relations trouv√©es
let foundParagraphRelations = [];

// Fonction pour analyser le paragraphe (version preview)
async function analyzeParagraph() {
  const text = (document.getElementById('free-text') || {}).value?.trim();
  const hint = (document.getElementById('free-text-hint') || {}).value?.trim();

  if (!text) {
    alert('Veuillez coller un paragraphe.');
    return;
  }

  try {
    notify('Analyse du paragraphe en cours...', 'info');

    const res = await fetch(`/expert/document/{{ document.id }}/analyze-paragraph/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
      body: JSON.stringify({ text, hint, preview_only: true })
    });

    const data = await res.json();

    if (data.success) {
      foundParagraphRelations = data.relations || [];
      displayFoundRelations(foundParagraphRelations);
      notify(`‚úÖ ${foundParagraphRelations.length} relations trouv√©es`, 'success');
    } else {
      notify('‚ùå ' + (data.error || 'Erreur lors de l\'analyse'), 'error');
    }
  } catch (e) {
    notify('‚ùå ' + e.message, 'error');
  }
}

// Fonction pour afficher les relations trouv√©es
function displayFoundRelations(relations) {
  const previewSection = document.getElementById('paragraph-relations-preview');
  const initialActions = document.getElementById('paragraph-initial-actions');
  const countEl = document.getElementById('found-relations-count');
  const listEl = document.getElementById('found-relations-list');

  if (relations.length === 0) {
    notify('Aucune relation trouv√©e dans ce paragraphe', 'warning');
    return;
  }

  // Masquer les boutons initiaux et afficher l'aper√ßu
  initialActions.style.display = 'none';
  previewSection.style.display = 'block';

  countEl.textContent = `${relations.length} relation${relations.length > 1 ? 's' : ''} identifi√©e${relations.length > 1 ? 's' : ''}`;

  listEl.innerHTML = relations.map((rel, index) => `
    <div class="found-relation-item" data-index="${index}">
      <div class="found-relation-content">
        <div class="found-entity-node">${rel.source.value}</div>
        <div class="found-relation-type">${rel.type.replace(/_/g, ' ')}</div>
        <span style="color:var(--pharma-accent);font-weight:bold;">‚Üí</span>
        <div class="found-entity-node">${rel.target.value}</div>
        ${rel.description ? `<div class="found-relation-description">"${rel.description}"</div>` : ''}
      </div>
      <div class="found-relation-actions">
        <button class="found-relation-btn" onclick="editFoundRelation(${index})" title="Modifier">
          <i class="fas fa-edit"></i>
        </button>
        <button class="found-relation-btn delete" onclick="deleteFoundRelation(${index})" title="Supprimer">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  `).join('');
}

// EXPOSER TOUTES LES FONCTIONS DANS L'OBJET WINDOW
window.analyzeParagraph = analyzeParagraph;

window.editFoundRelation = function(index) {
  const relation = foundParagraphRelations[index];
  if (!relation) return;

  const newDescription = prompt(
    `Modifier la description de la relation:\n${relation.source.value} ‚Üí ${relation.type} ‚Üí ${relation.target.value}`,
    relation.description || ''
  );

  if (newDescription !== null) {
    relation.description = newDescription.trim() || undefined;
    displayFoundRelations(foundParagraphRelations);
    notify('Description modifi√©e', 'success');
  }
};

window.deleteFoundRelation = function(index) {
  if (confirm('Supprimer cette relation ?')) {
    foundParagraphRelations.splice(index, 1);
    displayFoundRelations(foundParagraphRelations);
    notify('Relation supprim√©e', 'success');
  }
};

window.clearParagraphAnalysis = function() {
  foundParagraphRelations = [];
  document.getElementById('paragraph-relations-preview').style.display = 'none';
  document.getElementById('paragraph-initial-actions').style.display = 'flex';
  document.getElementById('free-text').value = '';
  document.getElementById('free-text-hint').value = '';
};

window.reAnalyzeParagraph = function() {
  document.getElementById('paragraph-relations-preview').style.display = 'none';
  document.getElementById('paragraph-initial-actions').style.display = 'flex';
  foundParagraphRelations = [];
  analyzeParagraph();
};

window.saveParagraphRelations = async function() {
  if (foundParagraphRelations.length === 0) {
    notify('Aucune relation √† sauvegarder', 'warning');
    return;
  }

  try {
    notify('Sauvegarde des relations...', 'info');

    const res = await fetch(`/expert/document/{{ document.id }}/save-paragraph-relations/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
      body: JSON.stringify({
        relations: foundParagraphRelations,
        source: 'paragraph_analysis'
      })
    });

    const data = await res.json();

    if (data.success) {
      notify(`‚úÖ ${data.saved_count} relations sauvegard√©es`, 'success');
      hideModal('add-text-modal');
      clearParagraphAnalysis();
      setTimeout(() => location.reload(), 800);
    } else {
      notify('‚ùå ' + (data.error || 'Erreur lors de la sauvegarde'), 'error');
    }
  } catch (e) {
    notify('‚ùå ' + e.message, 'error');
  }
};

// Garder l'ancienne fonction pour compatibilit√© (maintenant elle fait juste l'analyse)
window.addFromParagraph = analyzeParagraph;

  /* ======= Layout & plein √©cran ======= */
  function resizeVisualBuilder(){
    const modal   = document.getElementById('visual-relation-modal');
    if(!modal || !modal.classList.contains('show')) return;

    const content = modal.querySelector('.modal-content-semantic');
    const header  = content.querySelector('.modal-header-semantic');
    const body    = content.querySelector('.modal-body-semantic');
    const builder = body.querySelector('.visual-relation-builder');
    const toolbar = builder.querySelector('.builder-toolbar');
    const summary = builder.querySelector('.relations-summary');
    const canvas  = document.getElementById('visual-canvas');

    const bodyH = content.clientHeight - header.offsetHeight;
    body.style.height = bodyH + 'px';

    const canvasH = Math.max(360, bodyH - toolbar.offsetHeight - summary.offsetHeight - 16);
    canvas.style.height = canvasH + 'px';

    // Met √† jour la variable CSS pour la position du panel
    builder.style.setProperty('--vrb-summary-h', summary.offsetHeight + 'px');

    // Repositionne le panel et redessine les courbes
    centerRelationPanel();
    requestAnimationFrame(() => { try { renderConnections && renderConnections(); } catch(_){} });
  }
  window.resizeVisualBuilder = resizeVisualBuilder;

  function toggleVRBFullscreen(){
    const modal   = document.getElementById('visual-relation-modal');
    const content = modal.querySelector('.modal-content-semantic');
    const btn     = document.getElementById('vrb-fullscreen-btn');
    content.classList.toggle('fullscreen');
    if(btn){
      const isFS = content.classList.contains('fullscreen');
      btn.innerHTML = isFS ? '<i class="fas fa-compress"></i> R√©duire' : '<i class="fas fa-expand"></i> Plein √©cran';
    }
    setTimeout(resizeVisualBuilder, 50);
  }
  window.toggleVRBFullscreen = toggleVRBFullscreen;

  window.addEventListener('resize', () => resizeVisualBuilder());
  const _oldShowVRB = window.showVisualRelationBuilder;
  window.showVisualRelationBuilder = function(){
    _oldShowVRB();
    setTimeout(() => {
      // Activer automatiquement le mode plein √©cran
      toggleVRBFullscreen();
      resizeVisualBuilder();
      // Charger les annotations et le JSON au d√©marrage
      loadDocumentAnnotations();
      loadDocumentJSON();
    }, 150);
  };

  /* =================== FONCTIONS PALETTE ONGLETS =================== */

  let documentAnnotations = [];
  let currentPaletteTab = 'entities';

  // Changer d'onglet dans la palette
  function switchPaletteTab(tabName) {
    currentPaletteTab = tabName;

    // Mettre √† jour les onglets actifs
    document.querySelectorAll('.palette-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.tab === tabName);
    });

    // Afficher/masquer les contenus
    document.getElementById('palette-entities-content').style.display = tabName === 'entities' ? 'block' : 'none';
    document.getElementById('palette-annotations-content').style.display = tabName === 'annotations' ? 'block' : 'none';
    document.getElementById('palette-json-content').style.display = tabName === 'json' ? 'block' : 'none';

    // Redimensionner Monaco Editor quand l'onglet JSON est affich√©
    if (tabName === 'json' && jsonMonacoEditor) {
      setTimeout(() => {
        jsonMonacoEditor.layout();
      }, 50);
    }
  }
  window.switchPaletteTab = switchPaletteTab;

  /* =================== FONCTIONS ANNOTATIONS =================== */

  // Charger les annotations du document
  function loadDocumentAnnotations() {
    const basicData = BASIC || {};
    documentAnnotations = [];

    // Extraire toutes les entit√©s du JSON basique
    if (basicData.entities) {
      Object.keys(basicData.entities).forEach(entityType => {
        const entities = basicData.entities[entityType];
        if (Array.isArray(entities)) {
          entities.forEach(entity => {
            documentAnnotations.push({
              type: entityType,
              value: entity.value || entity.name || entity,
              confidence: entity.confidence || 1.0,
              page: entity.page || null,
              original: entity
            });
          });
        }
      });
    }

    // Peupler la liste d√©roulante
    populateAnnotationSelect();
    updateAnnotationStats();
  }

  // Remplir la liste d√©roulante des annotations
  function populateAnnotationSelect() {
    const select = document.getElementById('annotation-select');
    select.innerHTML = '';

    if (documentAnnotations.length === 0) {
      select.innerHTML = '<option value="">-- Aucune annotation disponible --</option>';
      return;
    }

    // Grouper par type
    const grouped = {};
    documentAnnotations.forEach((ann, idx) => {
      if (!grouped[ann.type]) grouped[ann.type] = [];
      grouped[ann.type].push({ ...ann, index: idx });
    });

    // Ajouter les options group√©es
    Object.keys(grouped).sort().forEach(type => {
      const optgroup = document.createElement('optgroup');
      optgroup.label = `üìå ${type.charAt(0).toUpperCase() + type.slice(1)} (${grouped[type].length})`;

      grouped[type].forEach(ann => {
        const option = document.createElement('option');
        option.value = ann.index;
        const confidence = Math.round(ann.confidence * 100);
        const pageInfo = ann.page ? ` [Page ${ann.page}]` : '';
        option.textContent = `${ann.value}${pageInfo} (${confidence}%)`;
        optgroup.appendChild(option);
      });

      select.appendChild(optgroup);
    });
  }

  // Filtrer les annotations par recherche
  function filterAnnotations(query) {
    const select = document.getElementById('annotation-select');
    const options = select.getElementsByTagName('option');

    query = query.toLowerCase();

    Array.from(options).forEach(option => {
      const text = option.textContent.toLowerCase();
      option.style.display = text.includes(query) ? '' : 'none';
    });
  }
  window.filterAnnotations = filterAnnotations;

  // G√©rer la s√©lection d'une annotation
  function handleAnnotationSelection(select) {
    const index = parseInt(select.value);
    if (isNaN(index)) return;

    const annotation = documentAnnotations[index];
    if (annotation) {
      // Afficher l'aper√ßu
      document.getElementById('annotation-preview').style.display = 'block';
      const previewContent = document.getElementById('annotation-preview-content');
      previewContent.innerHTML = `
        <strong>Type:</strong> ${annotation.type}<br>
        <strong>Valeur:</strong> ${annotation.value}<br>
        <strong>Confiance:</strong> ${Math.round(annotation.confidence * 100)}%
        ${annotation.page ? `<br><strong>Page:</strong> ${annotation.page}` : ''}
      `;
    }
  }
  window.handleAnnotationSelection = handleAnnotationSelection;

  // Ajouter l'annotation s√©lectionn√©e au canvas
  function addSelectedAnnotationToCanvas() {
    const select = document.getElementById('annotation-select');
    const index = parseInt(select.value);

    if (isNaN(index)) {
      alert('Veuillez s√©lectionner une annotation');
      return;
    }

    const annotation = documentAnnotations[index];
    if (!annotation) return;

    // V√©rifier si l'entit√© existe d√©j√†
    const exists = allEntities.find(e =>
      e.type === annotation.type &&
      e.value.toLowerCase() === annotation.value.toLowerCase()
    );

    if (exists) {
      alert('Cette entit√© est d√©j√† dans la liste');
      return;
    }

    // Ajouter √† allEntities
    const newEntity = {
      type: annotation.type,
      value: annotation.value,
      id: `ann_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
    };

    allEntities.push(newEntity);

    // Ajouter au canvas avec des coordonn√©es al√©atoires
    const canvas = document.getElementById('visual-canvas');
    const canvasWidth = canvas ? canvas.offsetWidth - 200 : 600;
    const canvasHeight = canvas ? canvas.offsetHeight - 100 : 400;
    const randomX = Math.random() * Math.max(100, canvasWidth - 100) + 50;
    const randomY = Math.random() * Math.max(100, canvasHeight - 100) + 50;
    addEntityToCanvas(newEntity, randomX, randomY);

    // Mettre √† jour la liste d'entit√©s
    populateEntityList();

    // Basculer sur l'onglet Entit√©s
    switchPaletteTab('entities');

    // Feedback visuel
    showToast(`‚úÖ "${annotation.value}" ajout√© au canvas`);
  }
  window.addSelectedAnnotationToCanvas = addSelectedAnnotationToCanvas;

  // Aper√ßu de l'annotation
  function previewAnnotation() {
    const select = document.getElementById('annotation-select');
    const index = parseInt(select.value);

    if (isNaN(index)) {
      alert('Veuillez s√©lectionner une annotation');
      return;
    }

    handleAnnotationSelection(select);
  }
  window.previewAnnotation = previewAnnotation;

  // Mettre √† jour les statistiques
  function updateAnnotationStats() {
    document.getElementById('total-annotations').textContent = documentAnnotations.length;

    // Compter les annotations utilis√©es
    const used = documentAnnotations.filter(ann =>
      allEntities.some(e =>
        e.type === ann.type &&
        e.value.toLowerCase() === ann.value.toLowerCase()
      )
    ).length;

    document.getElementById('used-annotations').textContent = used;
  }

  /* =================== FONCTIONS JSON VIEWER =================== */

  let currentJSON = {};

  // Charger et afficher le JSON
  function loadDocumentJSON() {
    const basicData = BASIC || {};
    currentJSON = basicData;

    if (jsonMonacoEditor) {
      jsonMonacoEditor.setValue(JSON.stringify(basicData, null, 2));
    }
  }

  // Formater le JSON
  function formatJSON() {
    if (!jsonMonacoEditor) {
      showToast('‚ùå √âditeur non initialis√©', 'error');
      return;
    }
    try {
      const text = jsonMonacoEditor.getValue();
      const parsed = JSON.parse(text);
      jsonMonacoEditor.setValue(JSON.stringify(parsed, null, 2));
      currentJSON = parsed;
      showToast('‚úÖ JSON format√©');
    } catch (e) {
      showToast('‚ùå Erreur: JSON invalide', 'error');
      console.error('Erreur de parsing JSON:', e);
    }
  }
  window.formatJSON = formatJSON;

  // Copier le JSON
  function copyJSON() {
    if (!jsonMonacoEditor) {
      showToast('‚ùå √âditeur non initialis√©', 'error');
      return;
    }
    const text = jsonMonacoEditor.getValue();
    navigator.clipboard.writeText(text).then(() => {
      showToast('‚úÖ JSON copi√© dans le presse-papiers');
    }).catch(err => {
      console.error('Erreur de copie:', err);
      showToast('‚ùå Impossible de copier le JSON', 'error');
    });
  }
  window.copyJSON = copyJSON;

  // Sauvegarder le JSON √©dit√©
  function saveEditedJSON() {
    if (!jsonMonacoEditor) {
      showToast('‚ùå √âditeur non initialis√©', 'error');
      return;
    }
    try {
      const text = jsonMonacoEditor.getValue();
      const parsed = JSON.parse(text);
      currentJSON = parsed;

      // Mettre √† jour BASIC avec le nouveau JSON
      Object.keys(BASIC).forEach(key => delete BASIC[key]);
      Object.assign(BASIC, parsed);

      // R√©extraire les entit√©s depuis le JSON mis √† jour
      extractAllEntities(BASIC);
      populateEntityTypeSelect();  // Mettre √† jour les types d'entit√©s
      populateEntityList();

      showToast('‚úÖ JSON sauvegard√© et entit√©s mises √† jour');
    } catch (e) {
      showToast('‚ùå Erreur: JSON invalide', 'error');
      console.error('Erreur de sauvegarde JSON:', e);
    }
  }
  window.saveEditedJSON = saveEditedJSON;

  // Toast notification
  function showToast(message) {
    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;bottom:2rem;right:2rem;background:#10b981;color:#fff;padding:1rem 1.5rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:99999;animation:slideInUp .3s ease-out';
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'fadeOut .3s ease-out';
      setTimeout(() => toast.remove(), 300);
    }, 2000);
  }

  /* =================== FONCTIONS PDF SIDE-BY-SIDE =================== */

  let currentPDFPage = 1;
  const totalPDFPages = {{ document.total_pages }};
  let pdfSelectionEnabled = false;
  let selectedPDFText = '';
  let pdfLoadAttempts = 0;

  // Gestionnaire d'erreur de chargement PDF
  function handlePDFLoadError(iframe) {
    pdfLoadAttempts++;
    console.error('Erreur de chargement du PDF via proxy (tentative ' + pdfLoadAttempts + ')');

    if (pdfLoadAttempts === 1 && iframe.dataset.fallbackUrl) {
      console.log('Tentative avec URL de secours:', iframe.dataset.fallbackUrl);
      iframe.src = iframe.dataset.fallbackUrl;
    } else if (pdfLoadAttempts >= 2) {
      console.error('√âchec du chargement du PDF avec les deux m√©thodes');
      const container = iframe.parentElement;
      container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#fef2f2;color:#dc2626;flex-direction:column;gap:1rem;padding:2rem;text-align:center;">' +
        '<i class="fas fa-exclamation-triangle" style="font-size:4rem;"></i>' +
        '<p style="font-weight:600;">Impossible de charger le PDF</p>' +
        '<p style="font-size:0.9rem;">Le fichier est introuvable ou inaccessible.</p>' +
        '<p style="font-size:0.85rem;color:#666;">URL proxy: {% url "expert:proxy_pdf" document.id %}</p>' +
        '<p style="font-size:0.85rem;color:#666;">URL directe: {{ document.file.url }}</p>' +
        '</div>';
    }
  }
  window.handlePDFLoadError = handlePDFLoadError;

  function navigatePDFPage(delta) {
    const newPage = currentPDFPage + delta;
    if (newPage < 1 || newPage > totalPDFPages) return;

    currentPDFPage = newPage;
    updatePDFViewer();
    updatePDFControls();
  }
  window.navigatePDFPage = navigatePDFPage;

  function updatePDFViewer() {
    const iframe = document.getElementById('pdf-viewer-frame');
    if (!iframe) return;

    // Mettre √† jour l'URL du PDF avec le num√©ro de page
    const pdfUrl = '{% url 'expert:proxy_pdf' document.id %}';
    iframe.src = `${pdfUrl}#page=${currentPDFPage}&view=FitH`;
  }

  function updatePDFControls() {
    const prevBtn = document.getElementById('pdf-prev-page');
    const nextBtn = document.getElementById('pdf-next-page');
    const pageSpan = document.getElementById('current-pdf-page');

    if (pageSpan) pageSpan.textContent = currentPDFPage;
    if (prevBtn) prevBtn.disabled = currentPDFPage === 1;
    if (nextBtn) nextBtn.disabled = currentPDFPage === totalPDFPages;
  }

  function togglePDFSelection(enabled) {
    pdfSelectionEnabled = enabled;
    const iframe = document.getElementById('pdf-viewer-frame');

    if (enabled) {
      // Activer la s√©lection de texte
      if (iframe) {
        iframe.style.pointerEvents = 'auto';
        iframe.style.userSelect = 'text';
      }
      notify('Mode s√©lection activ√© - S√©lectionnez du texte dans le PDF', 'info');
    } else {
      // D√©sactiver la s√©lection
      if (iframe) {
        iframe.style.pointerEvents = 'auto';
        iframe.style.userSelect = 'none';
      }
      hideSelectedTextPreview();
    }
  }
  window.togglePDFSelection = togglePDFSelection;

  // √âcouter les √©v√©nements de s√©lection de texte dans le PDF
  function setupPDFTextSelection() {
    const iframe = document.getElementById('pdf-viewer-frame');
    if (!iframe) return;

    // √âcouter les messages depuis l'iframe (si m√™me origine)
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'text-selected') {
        handlePDFTextSelection(event.data.text);
      }
    });

    // Fallback: utiliser document.getSelection()
    document.addEventListener('mouseup', () => {
      if (!pdfSelectionEnabled) return;

      setTimeout(() => {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();

        if (selectedText && selectedText.length > 0) {
          handlePDFTextSelection(selectedText);
        }
      }, 100);
    });
  }

  function handlePDFTextSelection(text) {
    if (!text || text.length === 0) return;

    selectedPDFText = text;
    showSelectedTextPreview(text);
  }

  function showSelectedTextPreview(text) {
    const preview = document.getElementById('pdf-selected-text-preview');
    const content = document.getElementById('pdf-selected-text-content');

    if (preview && content) {
      content.textContent = text;
      preview.style.display = 'block';

      // Scroll vers la pr√©visualisation
      preview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  function hideSelectedTextPreview() {
    const preview = document.getElementById('pdf-selected-text-preview');
    if (preview) {
      preview.style.display = 'none';
    }
    selectedPDFText = '';
  }

  function createEntityFromPDFSelection() {
    if (!selectedPDFText || selectedPDFText.length === 0) {
      notify('Aucun texte s√©lectionn√©', 'warning');
      return;
    }

    // Remplir le champ de cr√©ation d'entit√© avec le texte s√©lectionn√©
    const nameInput = document.getElementById('new-entity-name');
    if (nameInput) {
      nameInput.value = selectedPDFText;
      nameInput.focus();

      // Sugg√©rer un type d'entit√© bas√© sur le texte
      const typeSelect = document.getElementById('new-entity-type');
      if (typeSelect) {
        const suggestedType = suggestEntityType(selectedPDFText);
        if (suggestedType) {
          typeSelect.value = suggestedType;
        }
      }

      notify('‚úÖ Texte pr√™t √† √™tre cr√©√© comme entit√©', 'success');
      hideSelectedTextPreview();
    }
  }
  window.createEntityFromPDFSelection = createEntityFromPDFSelection;

  function suggestEntityType(text) {
    const lowerText = text.toLowerCase();

    // Patterns pour sugg√©rer le type
    if (/\d+\s*(mg|g|ml|mcg|¬µg|%)/i.test(text)) return 'dosage';
    if (/indication|traitement|th√©rapie/i.test(lowerText)) return 'indication';
    if (/contre[-\s]?indication/i.test(lowerText)) return 'contraindication';
    if (/principe actif|substance/i.test(lowerText)) return 'ingredient';

    // Par d√©faut, retourner null pour laisser le choix √† l'utilisateur
    return null;
  }

  // Initialiser les fonctions PDF au chargement
  setTimeout(() => {
    setupPDFTextSelection();
    updatePDFControls();
  }, 500);

  /* ======= Fonctions utilitaires pour le builder ======= */
  window.clearCanvas = function() {
    if (confirm('Voulez-vous vraiment effacer toutes les relations et entit√©s du canvas?')) {
      canvasEntities = [];
      canvasRelations = [];
      document.getElementById('visual-canvas').innerHTML = '<svg class="connection-svg" id="connection-svg" preserveAspectRatio="none"><defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="var(--pharma-accent)" /></marker></defs></svg>';
      updateRelationsSummary();
      notify('Canvas effac√©', 'info');
    }
  };

  window.autoArrange = function() {
    if (canvasEntities.length === 0) return;
    autoArrangeWithRelations();
    notify('Entit√©s arrang√©es automatiquement', 'success');
  };
})();
</script>

{% endblock %}