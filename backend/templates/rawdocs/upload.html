{% extends "base.html" %}
{% load static %}

{% block title %}Importer un PDF – RawDocs{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pdf-upload.css' %}">
{% endblock %}

{% block content %}
<div class="upload-container">

  {% if messages %}
  <div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
      <i class="fas fa-info-circle"></i>
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}


  <form method="post" enctype="multipart/form-data" class="upload-form">
    {% csrf_token %}
    <h2 class="upload-title">
      <i class="fas fa-upload"></i> Importer un document
    </h2>

    <div class="form-group">
      <label for="pdf_url">Depuis une URL de PDF :</label>
      <input
        type="url"
        name="pdf_url"
        id="pdf_url"
        placeholder="Collez l'URL du PDF à importer"
        value="{{ form.pdf_url.value|default_if_none:'' }}"
        class="form-input"
      />
    </div>

    <div class="form-separator">OU</div>

    <div class="form-group">
      <label for="pdf_file">Depuis un fichier local :</label>
      <div class="drop-zone" id="dropZone">
        <div class="drop-icon">
          <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <p class="drop-text">Glissez-déposez un fichier PDF ici</p>
        <p class="drop-subtext">ou cliquez pour sélectionner</p>
        <p class="file-info" id="fileInfo"></p>
      </div>
      <input type="file" id="pdf_file" name="pdf_file" accept="application/pdf,application/zip" style="display: none;">
    </div>

    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
      <button type="submit" name="upload" class="btn btn-primary">
        <i class="fas fa-upload"></i> Extraire
      </button>

    </div>
  </form>


  {% if is_zip_upload and processed_docs %}
  <div class="multi-document-container-clean">
    {# Replaced carousel with clean browser-style tabs #}
    <div class="document-tabs-bar">
      <div class="tabs-wrapper">
        {% for doc_data in processed_docs %}
        <button type="button"
                class="document-tab {% if forloop.first %}active{% endif %}"
                data-doc-index="{{ forloop.counter0 }}"
                onclick="switchToDocument({{ forloop.counter0 }})">
          <span class="tab-number">{{ forloop.counter }}</span>
          <div class="tab-info">
            <span class="tab-title" title="{{ doc_data.metadata.title|default:doc_data.doc.file.name }}">
              {{ doc_data.metadata.title|default:doc_data.doc.file.name|truncatechars:35 }}
            </span>
            <span class="tab-subtitle">
              {% if doc_data.metadata.type %}{{ doc_data.metadata.type|truncatechars:15 }}{% endif %}
              {% if doc_data.metadata.pages %} • {{ doc_data.metadata.pages }}p{% endif %}
            </span>
          </div>
          <span class="tab-status {% if doc_data.doc.is_validated %}validated{% else %}pending{% endif %}"></span>
        </button>
        {% endfor %}
      </div>
      <div class="tabs-actions">
        <span class="doc-counter">{{ processed_docs|length }} document{{ processed_docs|length|pluralize }}</span>
        <button type="button" class="nav-btn" onclick="navigateDocument(-1)" title="Précédent (←)">
          <i class="fas fa-chevron-left"></i>
        </button>
        <button type="button" class="nav-btn" onclick="navigateDocument(1)" title="Suivant (→)">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>

    {# Simplified document content area #}
    {% for doc_data in processed_docs %}
    <div class="document-content {% if not forloop.first %}hidden{% endif %}"
         id="document-{{ forloop.counter0 }}">

      {# View tabs for each document #}
      <div class="view-tabs-clean">
        <button type="button" class="view-tab active" data-view="metadata" onclick="switchView({{ forloop.counter0 }}, 'metadata')">
          <i class="fas fa-edit"></i>
          <span>Métadonnées</span>
        </button>
        <button type="button" class="view-tab" data-view="split" onclick="switchView({{ forloop.counter0 }}, 'split')">
          <i class="fas fa-columns"></i>
          <span>Vue divisée</span>
        </button>
        <button type="button" class="view-tab" data-view="pdf" onclick="switchView({{ forloop.counter0 }}, 'pdf')">
          <i class="fas fa-file-pdf"></i>
          <span>PDF Original</span>
        </button>
      </div>

      {# Metadata View #}
      <div class="view-content active" id="metadata-view-{{ forloop.counter0 }}">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-edit"></i>
              Éditer les métadonnées
            </h2>
            <div class="card-actions">
              <button type="button" class="btn btn-outline" onclick="reextractDoc('{{ doc_data.doc.id }}')">
                <i class="fas fa-sync"></i> Réextraire
              </button>
              <a href="{{ doc_data.doc.file.url }}" target="_blank" class="btn btn-view">
                <i class="fas fa-eye"></i> Voir
              </a>
            </div>
          </div>

          <form method="post" action="" class="metadata-form-multi" data-doc-id="{{ doc_data.doc.id }}">
            {% csrf_token %}
            <input type="hidden" name="doc_id" value="{{ doc_data.doc.id }}">
            <input type="hidden" name="edit_metadata" value="1">

            <div class="form-grid">
              <div class="form-field">
                <label class="field-label">
                  <i class="fas fa-heading"></i>
                  Titre du document
                  {% if doc_data.metadata.title %}<span class="auto-badge">Auto-extrait</span>{% endif %}
                </label>
                <input type="text" name="title" value="{{ doc_data.metadata.title|default:'' }}" class="form-input">
              </div>

              <div class="form-field">
                <label class="field-label">
                  <i class="fas fa-file-alt"></i>
                  Type de document
                  {% if doc_data.metadata.type %}<span class="auto-badge">Auto-détecté</span>{% endif %}
                </label>
                <input type="text" name="type" value="{{ doc_data.metadata.type|default:'' }}" class="form-input">
              </div>

              <div class="form-field full-width">
                <label class="field-label">
                  <i class="fas fa-align-left"></i>
                  Contexte
                </label>
                <textarea name="context" rows="3" class="form-input">{{ doc_data.metadata.context|default:'' }}</textarea>
              </div>

              <div class="form-field">
                <label class="field-label">
                  <i class="fas fa-language"></i>
                  Langue
                  {% if doc_data.metadata.language %}<span class="auto-badge">Auto-détectée</span>{% endif %}
                </label>
                <input type="text" name="language" value="{{ doc_data.metadata.language|default:'' }}" class="form-input">
              </div>

              <div class="form-field">
                <label class="field-label">
                  <i class="fas fa-calendar"></i>
                  Date de publication
                  {% if doc_data.metadata.publication_date %}<span class="auto-badge">Auto-extraite</span>{% endif %}
                </label>
                <input type="text" name="publication_date" value="{{ doc_data.metadata.publication_date|default:'' }}" class="form-input">
              </div>

              <div class="form-field">
                <label class="field-label">
                  <i class="fas fa-tag"></i>
                  Version
                </label>
                <input type="text" name="version" value="{{ doc_data.metadata.version|default:'' }}" class="form-input">
              </div>

              <div class="form-field">
                <label class="field-label">
                  <i class="fas fa-building"></i>
                  Source
                </label>
                <input type="text" name="source" value="{{ doc_data.metadata.source|default:'' }}" class="form-input">
              </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--card-border);">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Sauvegarder
              </button>
              {% if not doc_data.doc.is_validated %}
              <button type="button" class="btn btn-primary"
                      onclick="validateDocument('{{ doc_data.doc.id }}')"
                      data-validate-url="{% url 'rawdocs:validate_document' doc_data.doc.id %}">
                <i class="fas fa-check"></i> Valider
              </button>
              {% endif %}
            </div>
          </form>
        </div>
      </div>

      {# Split View #}
      <div class="view-content" id="split-view-{{ forloop.counter0 }}">
        <div class="card">
          <div class="split-view-container">
            <div class="split-panel">
              <div class="panel-content">
                <div class="panel-header gradient-blue">
                  <h3 class="panel-title">
                    <i class="fas fa-file-code"></i>
                    Contenu Structuré
                  </h3>
                  <div class="panel-controls">
                    <button type="button" class="control-btn-white toggle-edit-btn" data-doc-index="{{ forloop.counter0 }}" title="Mode édition">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="control-btn-white save-content-btn" data-doc-id="{{ doc_data.doc.id }}" data-doc-index="{{ forloop.counter0 }}" data-save-url="{% url 'rawdocs:save_structured_edits' doc_data.doc.id %}" title="Sauvegarder" style="display:none;">
                      <i class="fas fa-save"></i>
                    </button>
                    <button type="button" class="control-btn-white copy-html-btn" data-doc-index="{{ forloop.counter0 }}" title="Copier">
                      <i class="fas fa-copy"></i>
                    </button>
                    <button type="button" class="control-btn-white download-html-btn" data-doc-index="{{ forloop.counter0 }}" title="Télécharger">
                      <i class="fas fa-download"></i>
                    </button>
                  </div>
                </div>
                <div class="structured-content" id="structured-content-{{ forloop.counter0 }}">
                  {% if doc_data.structured_html_css %}<style>{{ doc_data.structured_html_css|safe }}</style>{% endif %}
                  <div class="zoom-container-multi pdf-document-container" id="zoom-container-multi-{{ forloop.counter0 }}">
                    {{ doc_data.structured_html|safe }}
                  </div>
                </div>
              </div>
            </div>

            <div class="split-panel">
              <div class="panel-content">
                <div class="panel-header gradient-red">
                  <h3 class="panel-title">
                    <i class="fas fa-file-pdf"></i>
                    PDF Original
                  </h3>
                  <div class="panel-controls">
                    <button type="button" class="control-btn-white" title="Rafraîchir">
                      <i class="fas fa-sync"></i>
                    </button>
                    <button type="button" class="control-btn-white" title="Plein écran">
                      <i class="fas fa-expand"></i>
                    </button>
                  </div>
                </div>
                <div class="pdf-viewer-container">
                  {% if doc_data.doc and doc_data.doc.file %}
                    <iframe
                      class="pdf-viewer"
                      src="{% url 'rawdocs:view_original_document' doc_data.doc.id %}#view=FitH&toolbar=1"
                      title="PDF Original">
                    </iframe>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {# PDF Only View #}
      <div class="view-content" id="pdf-view-{{ forloop.counter0 }}">
        <div class="card">
          <div class="panel-header gradient-red">
            <h3 class="panel-title">
              <i class="fas fa-file-pdf"></i>
              PDF Original
            </h3>
            <div class="panel-controls">
              <button type="button" class="control-btn-white" title="Télécharger">
                <i class="fas fa-download"></i>
              </button>
              <button type="button" class="control-btn-white" title="Plein écran">
                <i class="fas fa-expand"></i>
              </button>
            </div>
          </div>
          <div class="pdf-viewer-container" style="height: 800px;">
            {% if doc_data.doc and doc_data.doc.file %}
              <iframe
                class="pdf-viewer"
                src="{% url 'rawdocs:view_original_document' doc_data.doc.id %}#view=FitH&toolbar=1"
                title="PDF Original">
              </iframe>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {# Added JavaScript for clean tab navigation #}
  <script>
    let currentDocIndex = 0;
    const totalDocs = {{ processed_docs|length }};

    function switchToDocument(index) {
      // Update document tabs
      document.querySelectorAll('.document-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.document-tab[data-doc-index="${index}"]`).classList.add('active');

      // Update document content
      document.querySelectorAll('.document-content').forEach(content => content.classList.add('hidden'));
      document.getElementById(`document-${index}`).classList.remove('hidden');

      currentDocIndex = index;
      updateNavButtons();
    }

    function switchView(docIndex, viewName) {
      const docContent = document.getElementById(`document-${docIndex}`);

      // Update view tabs
      docContent.querySelectorAll('.view-tab').forEach(tab => tab.classList.remove('active'));
      docContent.querySelector(`.view-tab[data-view="${viewName}"]`).classList.add('active');

      // Update view content
      docContent.querySelectorAll('.view-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${viewName}-view-${docIndex}`).classList.add('active');
    }

    function navigateDocument(direction) {
      const newIndex = currentDocIndex + direction;
      if (newIndex >= 0 && newIndex < totalDocs) {
        switchToDocument(newIndex);
      }
    }

    function updateNavButtons() {
      const navBtns = document.querySelectorAll('.nav-btn');
      navBtns[0].disabled = currentDocIndex === 0;
      navBtns[1].disabled = currentDocIndex === totalDocs - 1;
    }

    function validateDocument(docId) {
      const button = event.target.closest('button');
      const validateUrl = button.getAttribute('data-validate-url');
      const form = document.querySelector(`.metadata-form-multi[data-doc-id="${docId}"]`);
      form.action = validateUrl;
      form.submit();
    }

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (document.querySelector('.multi-document-container-clean')) {
        if (e.key === 'ArrowLeft' && !e.target.matches('input, textarea')) {
          navigateDocument(-1);
        } else if (e.key === 'ArrowRight' && !e.target.matches('input, textarea')) {
          navigateDocument(1);
        }
      }
    });

    // Initialize
    if (document.querySelector('.multi-document-container-clean')) {
      updateNavButtons();
    }
  </script>
  {% elif doc and metadata %}

  <div class="document-results">

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-edit"></i>
          Éditer les métadonnées
        </h2>
        <div class="card-actions">
          <button type="button" id="reextractBtn" class="btn btn-outline" title="Réextraire">
            <i class="fas fa-sync"></i> Réextraire
          </button>
          <button type="button" class="btn btn-refuse" title="Refuser le document">
            <i class="fas fa-times"></i> Refuser
          </button>
          <a href="{{ doc.file.url }}" target="_blank" class="btn btn-view" title="Voir le document">
            <i class="fas fa-eye"></i> Voir
          </a>
          <button type="button" id="addFieldBtn" class="btn btn-outline">
            <i class="fas fa-plus"></i> Ajouter Champ
          </button>
        </div>
      </div>

      <form id="metadataForm" method="post" action="">
        {% csrf_token %}
        <input type="hidden" name="doc_id" value="{{ doc.id }}">
        <input type="hidden" name="edit_metadata" value="1">

        <div class="form-grid">
          <div class="form-field">
            <label class="field-label">
              <i class="fas fa-heading"></i>
              Titre du document
              {% if metadata.title %}<span class="auto-badge">Auto-extrait</span>{% endif %}
            </label>
            <input type="text" name="title" value="{{ edit_form.title.value|default:'' }}" class="form-input" placeholder="Titre du document">
          </div>

          <div class="form-field">
            <label class="field-label">
              <i class="fas fa-file-alt"></i>
              Type de document
              {% if metadata.type %}<span class="auto-badge">Auto-détecté</span>{% endif %}
            </label>
            <input type="text" name="type" value="{{ edit_form.type.value|default:'' }}" class="form-input" placeholder="Type de document">
          </div>

          <div class="form-field full-width">
            <label class="field-label">
              <i class="fas fa-align-left"></i>
              Contexte
              {% if metadata.context %}<span class="auto-badge">Auto-détecté</span>{% endif %}
            </label>
            <textarea name="context" rows="3" class="form-input" placeholder="Contexte du document">{{ edit_form.context.value|default:'' }}</textarea>
          </div>

          <div class="form-field">
            <label class="field-label">
              <i class="fas fa-language"></i>
              Langue
              {% if metadata.language %}<span class="auto-badge">Auto-détectée</span>{% endif %}
            </label>
            <input type="text" name="language" value="{{ edit_form.language.value|default:'' }}" class="form-input" placeholder="Langue">
          </div>

          <div class="form-field">
            <label class="field-label">
              <i class="fas fa-calendar"></i>
              Date de publication
              {% if metadata.publication_date %}<span class="auto-badge">Auto-extraite</span>{% endif %}
            </label>
            <input type="text" name="publication_date" value="{{ edit_form.publication_date.value|default:'' }}" class="form-input" placeholder="Ex: 23 January 2025">
          </div>

          <div class="form-field">
            <label class="field-label">
              <i class="fas fa-tag"></i>
              Version
            </label>
            <input type="text" name="version" value="{{ edit_form.version.value|default:'' }}" class="form-input" placeholder="Version du document">
          </div>

          <div class="form-field">
            <label class="field-label">
              <i class="fas fa-building"></i>
              Source
            </label>
            <input type="text" name="source" value="{{ edit_form.source.value|default:'' }}" class="form-input" placeholder="Source du document">
          </div>

          <div class="form-field">
            <label class="field-label">
              <i class="fas fa-globe"></i>
              Pays
            </label>
            <input type="text" name="country" value="{{ edit_form.country.value|default:'' }}" class="form-input" placeholder="Pays">
          </div>

          <div class="form-field full-width">
            <label class="field-label">
              <i class="fas fa-link"></i>
              URL Source
            </label>
            <input type="url" name="url_source" value="{{ edit_form.url_source.value|default:'' }}" class="form-input" placeholder="URL du document source">
          </div>

          <div id="customFields"></div>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--card-border);">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Sauvegarder
          </button>
          <a href="{% url 'rawdocs:document_list' %}" class="btn btn-outline">
            <i class="fas fa-arrow-left"></i> Retour à la liste
          </a>
          {% if doc and not doc.is_validated and not doc.is_refused %}
          <button type="button" class="btn btn-primary" id="validateBtn">
            <i class="fas fa-check"></i> Valider
          </button>
          {% endif %}
        </div>
      </form>
    </div>


    <div class="card">
      <div class="view-tabs">
        <button type="button" class="tab-btn active" data-view="split">
          <i class="fas fa-columns"></i> Vue divisée
        </button>
        <button type="button" class="tab-btn" data-view="structured">
          <i class="fas fa-file-code"></i> Contenu structuré uniquement
        </button>
        <button type="button" class="tab-btn" data-view="pdf">
          <i class="fas fa-file-pdf"></i> PDF original uniquement
        </button>
      </div>

      <div class="split-view-container" id="splitView">

        <div class="split-panel" id="structuredPanel">
          <div class="panel-content">
            {# Updated panel header with gradient background #}
            <div class="panel-header gradient-blue">
              <h3 class="panel-title">
                <i class="fas fa-file-code"></i>
                Contenu Structuré
              </h3>
              <div class="panel-controls">
                <button type="button" class="control-btn-white" id="toggleEditBtnSingle" title="Mode édition">
                  <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="control-btn-white" id="saveContentBtnSingle" data-doc-id="{{ doc.id }}" data-save-url="{% url 'rawdocs:save_structured_edits' doc.id %}" title="Sauvegarder" style="display:none;">
                  <i class="fas fa-save"></i>
                </button>
                <button type="button" class="control-btn-white" id="copyHtmlBtnSingle" title="Copier HTML">
                  <i class="fas fa-copy"></i>
                </button>
                <button type="button" class="control-btn-white" id="downloadHtmlBtnSingle" title="Télécharger HTML">
                  <i class="fas fa-download"></i>
                </button>
              </div>
            </div>
            <div class="structured-content">
              {% if structured_html_css %}<style>{{ structured_html_css|safe }}</style>{% endif %}
              <div class="zoom-container-single pdf-document-container" id="zoomContainerSingle">
                {{ structured_html|safe }}
              </div>
            </div>
          </div>
        </div>


        <div class="split-panel" id="pdfPanel">
          <div class="panel-content">
            {# Updated panel header with gradient background #}
            <div class="panel-header gradient-red">
              <h3 class="panel-title">
                <i class="fas fa-file-pdf"></i>
                PDF Original
              </h3>
              <div class="panel-controls">
                <button type="button" class="control-btn-white" id="refreshPdfBtn" title="Rafraîchir">
                  <i class="fas fa-sync"></i>
                </button>
                <button type="button" class="control-btn-white" id="fullscreenPdfBtn" title="Plein écran">
                  <i class="fas fa-expand"></i>
                </button>
              </div>
            </div>
            {# Fixed PDF viewer with proper URL and fallbacks #}
            <div class="pdf-viewer-container">
              {% if doc and doc.file %}
                <iframe
                  id="pdfFrame"
                  class="pdf-viewer"
                  src="{% url 'rawdocs:view_original_document' doc.id %}#view=FitH&toolbar=1&navpanes=0&scrollbar=1"
                  title="PDF Original"
                  allow="fullscreen">
                </iframe>

                <object
                  id="pdfObject"
                  class="pdf-viewer"
                  data="{% url 'rawdocs:view_original_document' doc.id %}"
                  type="application/pdf"
                  style="display: none;">
                  <p>Votre navigateur ne peut pas afficher le PDF.</p>
                </object>

                <div id="pdfFallback" style="display: none; padding: 20px; text-align: center;">
                  <div style="background: #f3f4f6; border-radius: 8px; padding: 20px; margin: 20px;">
                    <i class="fas fa-file-pdf" style="font-size: 48px; color: #ef4444; margin-bottom: 16px;"></i>
                    <h3 style="margin: 0 0 12px 0; color: #374151;">Votre navigateur ne peut pas afficher ce PDF</h3>
                    <p style="color: #6b7280; margin-bottom: 16px;">Utilisez l'une des options ci-dessous :</p>

                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                      <a href="{% url 'rawdocs:view_original_document' doc.id %}"
                         target="_blank"
                         class="btn btn-primary">
                        <i class="fas fa-external-link-alt"></i> Ouvrir dans un nouvel onglet
                      </a>

                      <a href="{{ doc.file.url }}?download=1"
                         class="btn btn-primary">
                        <i class="fas fa-download"></i> Télécharger
                      </a>

                      <button onclick="reloadPdfFrame()" class="btn btn-outline">
                        <i class="fas fa-refresh"></i> Recharger
                      </button>

                      <button onclick="switchToObjectView()" class="btn btn-outline">
                        <i class="fas fa-exchange-alt"></i> Mode alternatif
                      </button>
                    </div>
                  </div>
                </div>
              {% else %}
                <div style="padding: 20px; text-align: center; color: #6b7280;">
                  <i class="fas fa-info-circle"></i>
                  Aucun PDF original disponible.
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>


    {% if logs %}
    <div class="card">
      <h3 class="card-title">
        <i class="fas fa-history"></i>
        Historique des modifications
      </h3>
      <div class="history-list">
        {% for log in logs %}
        <div class="history-entry">
          <div class="history-field">{{ log.field_name }}</div>
          <div class="history-date">{{ log.modified_at|date:"d/m/Y H:i" }}</div>
          <div class="history-values">
            {% if log.old_value %}{{ log.old_value }}{% else %}(vide){% endif %}
            →
            {% if log.new_value %}{{ log.new_value }}{% else %}(vide){% endif %}
          </div>
          <div class="history-user">
            <i class="fas fa-user"></i>
            {{ log.modified_by.username }}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}
</div>

<script>
  // Pass custom fields data to JavaScript
  {% if custom_fields_data %}
  window.customFieldsData = {{ custom_fields_data|safe }};
  {% endif %}

  function reloadPdfFrame() {
    document.getElementById('pdfFrame').src = document.getElementById('pdfFrame').src;
  }

  function switchToObjectView() {
    var pdfFrame = document.getElementById('pdfFrame');
    var pdfObject = document.getElementById('pdfObject');
    var pdfFallback = document.getElementById('pdfFallback');

    if (pdfFrame.style.display !== 'none') {
      pdfFrame.style.display = 'none';
      pdfObject.style.display = 'block';
    } else if (pdfObject.style.display !== 'none') {
      pdfObject.style.display = 'none';
      pdfFallback.style.display = 'block';
    } else {
      pdfFallback.style.display = 'none';
      pdfFrame.style.display = 'block';
    }
  }

  function switchDocument(index) {
    // Update active card
    document.querySelectorAll('.doc-selector-card').forEach(card => card.classList.remove('active'));
    document.querySelector('.doc-selector-card[data-doc-index="' + index + '"]').classList.add('active');

    // Update content
    document.querySelectorAll('.doc-content').forEach(content => content.classList.add('hidden'));
    document.getElementById('doc-' + index).classList.remove('hidden');

    // Update progress indicators
    document.getElementById('currentDocNum').innerText = index + 1;

    // Update navigation buttons
    updateNavButtons(index);
  }

  function switchTab(docIndex, tabName) {
    // Update active tab button
    const docElement = document.getElementById('doc-' + docIndex);
    docElement.querySelectorAll('.doc-tab').forEach(tab => tab.classList.remove('active'));
    docElement.querySelector('.doc-tab[data-tab="' + tabName + '"]').classList.add('active');

    // Update active tab content
    docElement.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(tabName + '-' + docIndex).classList.add('active');
  }

  function updateNavButtons(currentIndex) {
    const totalDocs = parseInt(document.getElementById('totalDocs').innerText);
    const prevBtn = document.getElementById('prevDocBtnTop');
    const nextBtn = document.getElementById('nextDocBtnTop');

    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex === totalDocs - 1;
  }

  function validateDoc(docId) {
    const button = event.target.closest('button');
    const validateUrl = button.getAttribute('data-validate-url');
    const form = document.querySelector('.metadata-form-multi[data-doc-id="' + docId + '"]');
    form.action = validateUrl;
    form.submit();
  }

  function navigateDoc(step) {
    const currentIndex = parseInt(document.getElementById('currentDocNum').innerText) - 1;
    const newIndex = currentIndex + step;
    const totalDocs = parseInt(document.getElementById('totalDocs').innerText);

    if (newIndex >= 0 && newIndex < totalDocs) {
      switchDocument(newIndex);
    }
  }

  function scrollCarousel(step) {
    const carouselTrack = document.querySelector('.carousel-track');
    const cardWidth = document.querySelector('.doc-selector-card').offsetWidth;
    const currentScroll = carouselTrack.scrollLeft;
    const newScroll = currentScroll + (cardWidth + 10) * step;
    carouselTrack.scrollLeft = newScroll;
  }

  document.addEventListener('keydown', function(e) {
    if (document.querySelector('.multi-document-container')) {
      if (e.key === 'ArrowLeft') {
        navigateDoc(-1);
      } else if (e.key === 'ArrowRight') {
        navigateDoc(1);
      }
    }
  });

  // Initialize navigation buttons state
  if (document.querySelector('.multi-document-container')) {
    updateNavButtons(0);
  }
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/pdf-upload.js' %}"></script>
{% endblock %}